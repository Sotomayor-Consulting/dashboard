---
import { supabase } from "../lib/supabase";
const { cookies, redirect } = Astro;
import { Image } from 'astro:assets';
import imagen from "../assets/imagen-no.png";

// 1) Restaurar sesión
const at = cookies.get("sb-access-token");
const rt = cookies.get("sb-refresh-token");
if (!at || !rt) return redirect("/sign-in");

await supabase.auth.setSession({
  access_token: at.value,
  refresh_token: rt.value,
});

// 2) Usuario
const {
  data: { user },
  error: userErr,
} = await supabase.auth.getUser();
if (userErr || !user) return redirect("/sign-in");

// 3) ¿Es admin?
const { data: isAdmin, error: rpcErr } = await supabase.rpc("is_admin", {
  uid: user.id,
});

// 4) Si es admin → no mostrar nada (ni consultar)
let formularios: any[] = [];
if (!rpcErr && !isAdmin) {
  // 5) No admin → solo sus envíos
  const { data } = await supabase
    .from("formularios_envios")
    .select(`
      submission_id,
      form_id,
      user_id,
      status,
      data_json,
      schema_snapshot,
      progress_percent,
      created_at,
      updated_at,
      submitted_at,
      schema_hash,
      formularios:formularios ( form_id, titulo, slug, descripcion ),
      usuarios:usuarios ( user_id, nombre, apellido )
    `)
    .eq("user_id", user.id)
    .order("submitted_at", { ascending: true });

  formularios = data ?? [];
}
---

<div class="mb-10">
	<div class="grid grid-cols-1 px-4 pt-6 xl:gap-4">
		<div class="mb-4 col-span-full xl:mb-2">
			<nav class="flex mb-5" aria-label="Breadcrumb">
				<ol
					class="inline-flex items-center space-x-1 text-sm font-medium md:space-x-2"
				>
					<li class="inline-flex items-center">
						<a
							href="/"
							class="inline-flex items-center text-gray-700 hover:text-[#967432] dark:text-gray-300 dark:hover:text-primary-500"
						>
							<svg
								class="w-5 h-5 mr-2.5"
								fill="currentColor"
								viewBox="0 0 20 20"
								xmlns="http://www.w3.org/2000/svg"
								><path
									d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
								></path></svg
							>
							Inicio
						</a>
					</li>
					<li>
						<div class="flex items-center">
							<svg
								class="w-6 h-6 text-gray-400"
								fill="currentColor"
								viewBox="0 0 20 20"
								xmlns="http://www.w3.org/2000/svg"
								><path
									fill-rule="evenodd"
									d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
									clip-rule="evenodd"></path></svg
							>
							<span
								class="ml-1 text-gray-400 md:ml-2 dark:text-gray-500"
								aria-current="page">Tus documentos</span
							>
						</div>
					</li>
				</ol>
			</nav>
			<h1
				class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white"
			>
				Tus documentos
			</h1>
			<h3 class="mt-5 text-gray-400 md:ml-2 dark:text-gray-300">Formularios</h3>
		</div>
		<!-- Right Content -->
		<div class="grid xl:grid-cols-3 md:grid-cols-2 gap-2">
			{
				(formularios?.length ?? 0) === 0 ? (
					<div class="p-6 border rounded-lg text-center text-gray-600 dark:text-gray-300 col-span-3 flex flex-col items-center">
						<h3 class="text-lg font-semibold mb-5 ">
							No tienes formularios o documentos aún
						</h3>
						<Image src={imagen} alt="test" />
					</div>
				) : (
					formularios?.map((fr) => (
						<div class="flex flex-col items-end mb-4 bg-white border border-gray-200 rounded-lg shadow-sm md:flex-row md:max-w-xl hover:bg-gray-100 dark:border-gray-700 dark:bg-[#1d1d1d] dark:hover:bg-gray-700">
							<a
								href={`/forms/enviados/${fr.submission_id}`} target="_blank"
								class="flex w-full items-center"
							>
								<img
									class="object-cover w-full rounded-t-lg h-96 md:h-auto md:w-48 md:rounded-none md:rounded-s-lg"
									src="https://images.unsplash.com/photo-1554224154-22dec7ec8818?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&q=80&w=687"
									alt=""
								/>
								<div class="flex flex-col p-4 leading-normal h-fit">
									<h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
										{fr.formularios.titulo}
									</h5>
									<p class="mb-3 font-normal text-gray-700 dark:text-gray-400">
										{fr.formularios.descripcion}
									</p>
								</div>
							</a>
							<div class="w-fit mr-2 mb-2">
								<button id="dropdownMenuIconButton" data-dropdown-toggle={fr.submission_id} class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-neutral-700 dark:hover:bg-gray-700 dark:focus:ring-gray-600 z-10" type="button">
									<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 4 15">
									<path d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z"/>
									</svg>
								</button>

								<!-- Dropdown menu -->
								<div id={fr.submission_id} class="z-20 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm w-44 dark:bg-gray-700 dark:divide-gray-600">
									<ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownMenuIconButton">
										<li>
											<a href={`/forms/enviados/${fr.submission_id}`} target="_blank" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Ver respuestas</a>
										</li>
									</ul>
									<div class="py-2">
										<a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">Descargar pdf</a>
									</div>
								</div>
							</div>
							
						</div>
					))
				)
			}
		</div>
	</div>
	<hr class="w-48 h-1 mx-auto my-4 bg-gray-100 border-0 rounded-sm md:my-10 dark:bg-gray-700">
</div>
