---
import { supabase } from '../lib/supabase';
const { cookies, redirect } = Astro;

// 1) Restaurar sesión
const at = cookies.get('sb-access-token');
const rt = cookies.get('sb-refresh-token');
if (!at || !rt) return redirect('/sign-in');

await supabase.auth.setSession({
	access_token: at.value,
	refresh_token: rt.value,
});

// 2) Usuario
const {
	data: { user },
	error: userErr,
} = await supabase.auth.getUser();
if (userErr || !user) return redirect('/sign-in');

// 3) ¿Es admin?
const { data: isAdmin, error: rpcErr } = await supabase.rpc('is_admin', {
	uid: user.id,
});

// 4) Si es admin → no mostrar nada (ni consultar)
let empresas: any[] = [];
if (!rpcErr && !isAdmin) {
	// 5) No admin → solo sus envíos
	const { data } = await supabase
		.from('empresas_incorporaciones')
		.select(
			`
      user_id,
      empresa_incorporacion_id,
      tipo_de_negocio,
      estado_de_incorporacion,
      estado,
      nombre_1,
      nombre_2,
      nombre_3,
      updated_at
    `,
		)
		.eq('user_id', user.id)
		.order('updated_at', { ascending: true });

	empresas = data ?? [];
}
---

<div class="mb-10">
	<div class="grid grid-cols-1 px-4 pt-6 xl:gap-4">
		<div class="mb-4 col-span-full xl:mb-2">
			<nav class="flex mb-5" aria-label="Breadcrumb">
				<ol
					class="inline-flex items-center space-x-1 text-sm font-medium md:space-x-2"
				>
					<li class="inline-flex items-center">
						<a
							href="#"
							class="inline-flex items-center text-gray-700 hover:text-[#967432] dark:text-gray-300 dark:hover:text-primary-500"
						>
							<svg
								class="w-5 h-5 mr-2.5"
								fill="currentColor"
								viewBox="0 0 20 20"
								xmlns="http://www.w3.org/2000/svg"
								><path
									d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
								></path></svg
							>
							Inicio
						</a>
					</li>
					<li>
						<div class="flex items-center">
							<svg
								class="w-6 h-6 text-gray-400"
								fill="currentColor"
								viewBox="0 0 20 20"
								xmlns="http://www.w3.org/2000/svg"
								><path
									fill-rule="evenodd"
									d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
									clip-rule="evenodd"></path></svg
							>
							<a
								href="#"
								class="ml-1 text-gray-700 hover:text-[#967432] md:ml-2 dark:text-gray-300 dark:hover:text-primary-500"
								>Pages</a
							>
						</div>
					</li>
					<li>
						<div class="flex items-center">
							<svg
								class="w-6 h-6 text-gray-400"
								fill="currentColor"
								viewBox="0 0 20 20"
								xmlns="http://www.w3.org/2000/svg"
								><path
									fill-rule="evenodd"
									d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
									clip-rule="evenodd"></path></svg
							>
							<span
								class="ml-1 text-gray-400 md:ml-2 dark:text-gray-500"
								aria-current="page">Tus empresas</span
							>
						</div>
					</li>
				</ol>
			</nav>
			<h1
				class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white"
			>
				Tus empresas
			</h1>
			<h3 class="mt-5 text-gray-400 md:ml-2 dark:text-gray-300">empresas</h3>
		</div>
		<!-- Right Content -->
		<div class="grid xl:grid-cols-3 md:grid-cols-2 gap-2">
			{
				(empresas?.length ?? 0) === 0 ? (
					<div class="p-6 border rounded-lg text-center text-gray-600 dark:text-gray-300">
						<h3 class="text-lg font-semibold mb-1">No tienes empresas aún</h3>
					</div>
				) : (
					empresas?.map((fr) => (
						<a class="w-full max-w-sm bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-[#1d1d1d] dark:border-gray-700 place-self-center">
							<div class="flex justify-end mt-5 w-full">
								<span class="text-xs font-medium me-2 px-2.5 py-0.5 rounded-full dark:text-amber-600 flex gap-2 text-amber-600 items-center justify-center">
									<div class="bg-amber-600 rounded-full w-2 h-2" />
									{fr.estado}
								</span>
							</div>
							<div>
								<img
									class="p-8 rounded-xl"
									src="https://img.freepik.com/foto-gratis/vista-angulo-rascacielos_1359-1105.jpg?t=st=1761663456~exp=1761667056~hmac=17a4be840a1d49cf4c415cbb5269ac674a7946e7cf6eefd81b32557962581b4f&w=1480"
									alt="product image"
								/>
								<div class="px-5 pb-5">
									<div class="flex justify-between">
										<div>
											<h5 class="text-xl font-semibold tracking-tight text-gray-900 dark:text-white">
												{fr.nombre_1} - {fr.tipo_de_negocio}
											</h5>
											<p class="text-neutral-500">
												{fr.estado_de_incorporacion}
											</p>
										</div>
									</div>
								</div>
							</div>
						</a>
						
					))
				)
			}
		</div>
	</div>
	<hr
		class="w-48 h-1 mx-auto my-4 bg-gray-100 border-0 rounded-sm md:my-10 dark:bg-gray-700"
	/>
</div>
