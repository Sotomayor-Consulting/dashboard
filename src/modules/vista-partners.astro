---
import '../estilos/dropzone.css';
import { supabase } from '../lib/supabase';
import { Icon } from 'astro-icon/components';
import ImprimirContrato from '../components/ImprimirContrato.astro';

let datosParaReporte = {};

// Con RLS, no necesitas filtrar manualmente por user_id
const { data: usuario, error } = await supabase
	.from('usuarios')
	.select('*')
	.single();
if (usuario) {
	datosParaReporte = {
		nombre: [usuario.nombre, usuario.apellido].join(' '),
		correoElectronico: usuario.correo,
		fullAddress: [usuario.direccion_linea1, usuario.direccion_linea2].join(' '),
	};
}

if (error) {
	console.error('Error cargando usuario:', error);
}
console.log('Usuario cargado:', datosParaReporte);

const { data: documentos } = await supabase
	.from('documentos_usuarios')
	.select('*')
	.single();

const acciones = [
	{
		nombre: 'Mira tus partners',
		descripcion:
			'Encuentra links a tus documentos completados, bandeja de notificaciones, formularios, email, y descarga plantillas de documentos importantes.',
		link: '/partners/datos-referidos/',
		icono: 'ri:shake-hands-fill',
	},
	{
		nombre: 'Configura tu perfil',
		descripcion:
			'Inicia el proceso para crear una nueva empresa asociada a tu cuenta de partner.',
		link: '/settings/',
		icono: 'ri:account-circle-fill',
	},
	{
		nombre: 'Agenda una cita',
		descripcion:
			'Contacta a nuestro equipo de soporte para asistencia personalizada con tu cuenta de partner.',
		link: 'https://zcal.co/t/agendar-asesoria-llc/60min',
		icono: 'ri:calendar-fill',
	},
	{
		nombre: 'Contacta a soporte',
		descripcion:
			'Contacta a nuestro equipo de soporte para asistencia personalizada con tu cuenta de partner.',
		link: 'mailto:serviciossotomayorcoonsulting.com',
		icono: 'ri:customer-service-2-fill',
	},
];
interface Props {
	data: object;
	templateName?: string;
	reportName?: string;
}
---

<div class="px-4 pt-6">
	<div
		class="grid gap-4 w-full grid-cols-1 my-4 xl:grid-cols-2 2xl:grid-cols-3"
	>
		<div
			class="items-center justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm sm:flex dark:border-gray-700 sm:p-6 dark:bg-neutral-700"
		>
			<div class="w-full">
				<h3 class="text-base font-normal text-gray-500 dark:text-gray-400">
					Tu c√≥digo de partner
				</h3>
				<div class="w-full">
					<div class="relative">
						<label for="npm-install-input" class="sr-only">Label</label>
						<!-- Cambiado -->
						<input
							id="npm-install-input"
							type="text"
							class="block w-full text-2xl font-bold text-gray-900 sm:text-3xl dark:text-white bg-white rounded-xl dark:bg-neutral-700 border-0 p-0"
							value={usuario.codigo_de_partner}
							disabled
							readonly
						/>
						<button
							id="npm-install-copy-button"
							data-copy-to-clipboard-target="npm-install-input"
							data-tooltip-target="tooltip-copy-npm-install-copy-button"
							class="absolute
						end-2 top-1/2 -translate-y-1/2 text-white hover:bg-gray-100
						dark:hover:bg-[#967432] rounded-lg p-2 inline-flex items-center justify-center bg-[#967432]"
						>
							<span id="default-icon">
								<svg
									class="w-7 h-7"
									aria-hidden="true"
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									fill="none"
									viewBox="0 0 24 24"
									><path
										stroke="currentColor"
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-6 5h6m-6 4h6M10 3v4h4V3h-4Z"
									></path></svg
								>
							</span>
							<span id="success-icon" class="hidden">
								<svg
									class="w-7 h-7 text-fg-brand"
									aria-hidden="true"
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									fill="none"
									viewBox="0 0 24 24"
									><path
										stroke="currentColor"
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M15 4h3a1 1 0 0 1 1 1v15a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h3m0 3h6m-6 7 2 2 4-4m-5-9v4h4V3h-4Z"
									></path></svg
								>
							</span>
							<span class="ml-1 md:block hidden">Copiar c√≥digo</span>
						</button>
						<div
							id="tooltip-copy-npm-install-copy-button"
							role="tooltip"
							class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-xs opacity-0 tooltip dark:bg-neutral-800"
						>
							<span id="default-tooltip-message">Copiar codigo de partners</span
							>
							<span id="success-tooltip-message" class="hidden">Copiado!</span>
							<div class="tooltip-arrow" data-popper-arrow></div>
						</div>
					</div>
				</div>
				<p
					class="flex items-center text-base font-normal text-gray-500 dark:text-gray-400"
				>
					{usuario.correo}
				</p>
			</div>
		</div>

		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-neutral-700"
		>
			<div
				class="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm sm:flex sm:p-6 dark:bg-neutral-700"
			>
				<div class="w-full">
					<div class="flex items-center">
						<h3
							class="flex items-center mb-4 text-lg font-semibold text-gray-900 dark:text-white"
						>
							Estado de tu contrato de partner:
							<button
								data-popover-target="popover-description-2"
								data-popover-placement="bottom-end"
								type="button"
								><svg
									class="w-4 h-4 ml-2 text-gray-400 hover:text-gray-500"
									aria-hidden="true"
									fill="currentColor"
									viewBox="0 0 20 20"
									xmlns="http://www.w3.org/2000/svg"
									><path
										fill-rule="evenodd"
										d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
										clip-rule="evenodd"></path></svg
								><span class="sr-only">Mostrar informaci√≥n</span></button
							>
						</h3>
						<div
							data-popover
							id="popover-description-2"
							role="tooltip"
							class="absolute z-10 invisible inline-block text-sm font-light text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-sm opacity-0 w-72 dark:bg-[#1d1d1d] dark:border-gray-600 dark:text-gray-400"
						>
							<div class="p-3 space-y-2">
								<h3 class="font-semibold text-gray-900 dark:text-white">
									Contrato de partner
								</h3>
								<p>
									Si tu estado es "En proceso", significa que hemos recibido tu contrato y esta pendiente de revisi√≥n. Te notificaremos una vez que haya sido aprobado.
								</p>
							</div>
							<div data-popper-arrow></div>
						</div>
					</div>

					{
						documentos.estado === 'activo' ? (
							<span class="bg-green-100 text-green-800 text-lg font-medium me-5 px-5 py-2 rounded-full dark:bg-green-900 dark:text-green-300 flex justify-center items-center w-fit">
								<span class="size-3 inline-block rounded-full bg-green-400 dark:bg-green-400 mr-2" />
								Activo
							</span>
						) : (
							<span class="bg-yellow-100 text-yellow-800 text-lg font-medium me-5 px-5 py-2 rounded-full dark:bg-yellow-900 dark:text-yellow-300 flex justify-center items-center w-fit">
								<span class="size-3 inline-block rounded-full bg-yellow-400 dark:bg-yellow-400 mr-2" />
								En proceso
							</span>
						)
					}
				</div>
			</div>
		</div>

		<div
			class="items-center justify-between p-4 bg-white border border-gray-200 rounded-lg shadow-sm flex dark:border-gray-700 sm:p-6 dark:bg-neutral-700"
		>
			<div class="w-full">
				<h3 class="text-base font-normal text-gray-500 dark:text-gray-400">
					Plantilla de contrato:
				</h3>
				<div class="flex justify-between mt-5 items-center flex-col">
					<Icon
						name="ri:file-ai-2-fill"
						class="dark:text-white mb-3"
						width="70"
						height="70"
					/>
					<ImprimirContrato
						data={datosParaReporte}
						reportName="CONTRATO DE PARTNERS.pdf"
						templateName="CONTRATO_DE_PARTNERS.docx"
					/>
				</div>
			</div>
		</div>
	</div>
	<div
		class="grid gap-4 w-full grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 my-4"
	>
		<!-- Main widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-xl shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-neutral-700"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<span
						class="text-xl font-bold leading-none text-gray-900 sm:text-2xl dark:text-white"
						>Sube o Actualiza tu contrato</span
					>
					<h3 class="text-base font-light text-gray-500 dark:text-gray-400">
						Contrato de partner
					</h3>
				</div>
			</div>

			<div class="flex items-center justify-center w-full flex-col">
				<form
					id="my-dropzone"
					class="dropzone border-dashed border-2 border-gray-300 bg-gray-50 dark:bg-neutral-800 dark:border-gray-600 w-full p-6 h-96 rounded-2xl dark:hover:bg-neutral-800/80"
					action="/api/update/contrato-partner-upload"
					method="post"
					enctype="multipart/form-data"
				>
					<div class="dz-message dark:text-white w-full flex flex-col">
						<svg
							class="w-h-14 h-14 mb-4 text-gray-500 dark:text-gray-400"
							aria-hidden="true"
							xmlns="http://www.w3.org/2000/svg"
							fill="none"
							viewBox="0 0 20 16"
						>
							<path
								stroke="currentColor"
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"
							></path>
						</svg>
						Arrastra tu contrato aqu√≠ o haz clic para subir.
					</div>
				</form>

				<div class="mt-4 flex gap-3">
					<button
						type="button"
						id="btn-confirm-upload"
						class="px-4 py-2 rounded-lg bg-[#967432] hover:bg-[#967432] text-white disabled:opacity-50 disabled:cursor-not-allowed"
						disabled
					>
						Subir contrato
					</button>
				</div>
			</div>
		</div>
		<!--Tabs widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-neutral-700"
		>
			<h3
				class="flex items-center mb-4 text-lg font-semibold text-gray-900 dark:text-white"
			>
				Acciones rapidas
				<button
					data-popover-target="popover-description"
					data-popover-placement="bottom-end"
					type="button"
					><svg
						class="w-4 h-4 ml-2 text-gray-400 hover:text-gray-500"
						aria-hidden="true"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
							clip-rule="evenodd"></path></svg
					><span class="sr-only">Ayuda</span></button
				>
			</h3>
			<div
				data-popover
				id="popover-description"
				role="tooltip"
				class="absolute z-10 invisible inline-block text-sm font-light text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-sm opacity-0 w-72 dark:bg-neutral-700 dark:border-gray-600 dark:text-gray-400"
			>
				<div class="p-3 space-y-2">
					<h3 class="font-semibold text-gray-900 dark:text-white">
						Acciones rapidas
					</h3>
					<p>
						Encuentra links a tus documentos completados, bandeja de
						notificaciones, formularios, email, y descarga plantillas de
						documentos importantes.
					</p>
				</div>
				<div data-popper-arrow></div>
			</div>
			<div class="border-t border-gray-200 dark:border-gray-600">
				<div class="pt-4">
					<ul role="list" class="divide-y divide-gray-200 dark:divide-gray-700">
						{
							acciones?.map((ac) => (
								<li class="py-3 sm:py-4">
									<div class="flex items-center justify-between">
										<div class="flex items-center min-w-0">
											<Icon
												name={ac.icono}
												class="w-10 h-10 text-white hover:scale-105"
											/>
											<div class="ml-3">
												<p class="font-medium text-gray-900 truncate dark:text-white">
													{ac.nombre}
												</p>
											</div>
										</div>
										<a
											target="_blank"
											href={ac.link}
											class="text-white bg-[#967432] hover:bg-[#967432] focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center me-2 dark:bg-[#967432] dark:hover:bg-[#8c681d] dark:focus:ring-[#8c681d]"
										>
											<svg
												xmlns="http://www.w3.org/2000/svg"
												class="w-3.5 h-3.5 me-2"
												viewBox="0 0 16 16"
											>
												<>
													<path
														fill="currentColor"
														d="M15 1.31a.5.5 0 0 0-.461-.309h-4a.5.5 0 0 0 0 1h2.79l-7.15 7.15a.5.5 0 0 0 .707.707l7.15-7.15v2.79a.5.5 0 0 0 1 0v-4a.5.5 0 0 0-.038-.188z"
													/>
													<path
														fill="currentColor"
														d="M3.5 3A2.5 2.5 0 0 0 1 5.5v7A2.5 2.5 0 0 0 3.5 15h7a2.5 2.5 0 0 0 2.5-2.5v-5a.5.5 0 0 0-1 0v5a1.5 1.5 0 0 1-1.5 1.5h-7A1.5 1.5 0 0 1 2 12.5v-7A1.5 1.5 0 0 1 3.5 4h5a.5.5 0 0 0 0-1z"
													/>
												</>
											</svg>
											ir
										</a>
									</div>
								</li>
							))
						}
					</ul>
				</div>
			</div>
		</div>
	</div>
	<div
		class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-neutral-700 my-4"
	>
		<!-- Card header -->
		<div class="items-center justify-between lg:flex">
			<div class="mb-4 lg:mb-0">
				<h3 class="mb-2 text-xl font-bold text-gray-900 dark:text-white">
					Documentos
				</h3>
				<span class="text-base font-normal text-gray-500 dark:text-gray-400"
					>Tu lista de documentos de la empresa</span
				>
			</div>
		</div>
		<!-- Table -->
		<div class="flex flex-col mt-6">
			<div class="overflow-x-auto rounded-lg">
				<div class="inline-block min-w-full align-middle">
					<div class="overflow-hidden shadow sm:rounded-lg">
						<table
							class="min-w-full divide-y divide-gray-200 dark:divide-gray-600"
						>
							<thead class="bg-gray-50 dark:bg-neutral-700">
								<tr>
									<th
										scope="col"
										class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white"
									>
										Nombre del documento
									</th>
									<th
										scope="col"
										class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white"
									>
										Fecha
									</th>
									<th
										scope="col"
										class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white"
									>
										estado del documento
									</th>
									<th
										scope="col"
										class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white"
									>
										Ver documento
									</th>
									<th
										scope="col"
										class="p-4 text-xs font-medium tracking-wider text-left text-gray-500 uppercase dark:text-white"
									>
										Descargar
									</th>
								</tr>
							</thead>
							<tbody class="bg-white dark:bg-neutral-700">
								<tr>
									<td
										class="p-4 text-sm font-normal text-gray-900 whitespace-nowrap dark:text-white"
									>
										Payment from <span class="font-semibold">Bonnie Green</span>
									</td>
									<td
										class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400"
									>
										Apr 23 ,2021
									</td>
									<td class="p-4 whitespace-nowrap">
										<span
											class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-md dark:bg-neutral-700 dark:text-green-400 border border-green-100 dark:border-green-500 mx-auto"
											>Completado</span
										>
									</td>
									<td
										class="p-4 text-sm font-semibold text-gray-900 whitespace-nowrap dark:text-neutral-500"
									>
										<a
											href="http://"
											target="_blank"
											rel="noopener noreferrer"
											title="Ver documento"
											><svg
												xmlns="http://www.w3.org/2000/svg"
												class="hover:text-white transition-colors"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												><path
													fill="currentColor"
													d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"
												></path></svg
											></a
										>
									</td>
									<td
										class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-neutral-500"
									>
										<a href="" title="Descargar el documento">
											<svg
												class="hover:text-white transition-colors"
												width="24"
												height="24"
												fill="currentColor"
												viewBox="0 0 24 24"
												xmlns="http://www.w3.org/2000/svg"
												aria-hidden="true"
												data-astro-cid-d52ol5io=""
											>
												<path
													clip-rule="evenodd"
													fill-rule="evenodd"
													d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z"
													data-astro-cid-d52ol5io=""></path>
											</svg>
										</a>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<!-- Card Footer -->
		<div class="flex items-center justify-between pt-3 sm:pt-6">
			<div>
				<button
					class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 rounded-lg hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
					type="button"
					data-dropdown-toggle="transactions-dropdown"
					>Last 7 days <svg
						class="w-4 h-4 ml-2"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
						xmlns="http://www.w3.org/2000/svg"
						><path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M19 9l-7 7-7-7"></path></svg
					></button
				>
				<!-- Dropdown menu -->
				<div
					class="z-50 hidden my-4 text-base list-none bg-white divide-y divide-gray-100 rounded shadow dark:bg-neutral-700 dark:divide-gray-600"
					id="transactions-dropdown"
				>
					<div class="px-4 py-3" role="none">
						<p
							class="text-sm font-medium text-gray-900 truncate dark:text-white"
							role="none"
						>
							Sep 16, 2021 - Sep 22, 2021
						</p>
					</div>
					<ul class="py-1" role="none">
						<li>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
								role="menuitem">Yesterday</a
							>
						</li>
						<li>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
								role="menuitem">Today</a
							>
						</li>
						<li>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
								role="menuitem">Last 7 days</a
							>
						</li>
						<li>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
								role="menuitem">Last 30 days</a
							>
						</li>
						<li>
							<a
								href="#"
								class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
								role="menuitem">Last 90 days</a
							>
						</li>
					</ul>
					<div class="py-1" role="none">
						<a
							href="#"
							class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-white"
							role="menuitem">Custom...</a
						>
					</div>
				</div>
			</div>
			<div class="flex-shrink-0">
				<a
					href="#"
					class="inline-flex items-center p-2 text-xs font-medium uppercase rounded-lg text-[#8c681d] sm:text-sm hover:bg-gray-100 dark:text-primary-500 dark:hover:bg-neutral-700"
				>
					Transactions Report
					<svg
						class="w-4 h-4 ml-1 sm:w-5 sm:h-5"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
						xmlns="http://www.w3.org/2000/svg"
						><path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9 5l7 7-7 7"></path></svg
					>
				</a>
			</div>
		</div>
	</div>
</div>

<script is:inline>
	window.addEventListener('load', function () {
		// Agrega logs para debug
		console.log('Buscando instancias de Flowbite...');
		console.log('Instancias disponibles:', FlowbiteInstances?.instances);

		try {
			const clipboard = FlowbiteInstances.getInstance(
				'CopyClipboard',
				'npm-install-copy-button',
			);
			const tooltip = FlowbiteInstances.getInstance(
				'Tooltip',
				'tooltip-copy-npm-install-copy-button',
			);

			console.log('Clipboard instance:', clipboard);
			console.log('Tooltip instance:', tooltip);

			if (!clipboard) {
				throw new Error('No se encontr√≥ la instancia de CopyClipboard');
			}

			if (!tooltip) {
				throw new Error('No se encontr√≥ la instancia de Tooltip');
			}

			const $defaultIcon = document.getElementById('default-icon');
			const $successIcon = document.getElementById('success-icon');
			const $defaultTooltipMessage = document.getElementById(
				'default-tooltip-message',
			);
			const $successTooltipMessage = document.getElementById(
				'success-tooltip-message',
			);

			clipboard.updateOnCopyCallback((clipboard) => {
				showSuccess();
				setTimeout(() => {
					resetToDefault();
				}, 2000);
			});

			const showSuccess = () => {
				$defaultIcon.classList.add('hidden');
				$successIcon.classList.remove('hidden');
				$defaultTooltipMessage.classList.add('hidden');
				$successTooltipMessage.classList.remove('hidden');
				tooltip.show();
			};

			const resetToDefault = () => {
				$defaultIcon.classList.remove('hidden');
				$successIcon.classList.add('hidden');
				$defaultTooltipMessage.classList.remove('hidden');
				$successTooltipMessage.classList.add('hidden');
				tooltip.hide();
			};
		} catch (error) {
			console.error('Error inicializando Flowbite:', error);

			// Fallback: inicializar manualmente si Flowbite falla
			initializeManualFallback();
		}
	});

	// Fallback manual en caso de que Flowbite falle
	function initializeManualFallback() {
		console.log('Inicializando fallback manual...');

		const copyButton = document.getElementById('npm-install-copy-button');
		const inputField = document.getElementById('npm-install-input');

		if (!copyButton || !inputField) {
			console.error('Elementos no encontrados para el fallback');
			return;
		}

		copyButton.addEventListener('click', function () {
			// Seleccionar y copiar el texto
			inputField.select();
			inputField.setSelectionRange(0, 99999); // Para m√≥viles

			try {
				navigator.clipboard.writeText(inputField.value).then(() => {
					showManualSuccess();
				});
			} catch (err) {
				// Fallback para navegadores antiguos
				document.execCommand('copy');
				showManualSuccess();
			}
		});

		function showManualSuccess() {
			const $defaultIcon = document.getElementById('default-icon');
			const $successIcon = document.getElementById('success-icon');
			const $defaultTooltipMessage = document.getElementById(
				'default-tooltip-message',
			);
			const $successTooltipMessage = document.getElementById(
				'success-tooltip-message',
			);

			$defaultIcon.classList.add('hidden');
			$successIcon.classList.remove('hidden');
			$defaultTooltipMessage.classList.add('hidden');
			$successTooltipMessage.classList.remove('hidden');

			setTimeout(() => {
				$defaultIcon.classList.remove('hidden');
				$successIcon.classList.add('hidden');
				$defaultTooltipMessage.classList.remove('hidden');
				$successTooltipMessage.classList.add('hidden');
			}, 2000);
		}
	}
</script>

<script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js" is:inline
></script>
<script is:inline>
	Dropzone.autoDiscover = false;
</script>
<script is:inline>
	document.addEventListener('DOMContentLoaded', function () {
		if (typeof Dropzone === 'undefined') {
			console.error('Dropzone no est√° definido.');
			return;
		}

		Dropzone.autoDiscover = false;

		var form = document.getElementById('my-dropzone');
		var confirmBtn = document.getElementById('btn-confirm-upload');
		var tempTimeoutId = null;

		if (!form || !confirmBtn) return;

		var dz = new Dropzone(form, {
			url: form.getAttribute('action'),
			method: 'post',

			// üëá IMPORTANTE: mismo nombre que lee tu endpoint: formData.get("contract_file")
			paramName: 'contract_file',

			autoProcessQueue: false, // ‚ùó NO subir autom√°ticamente
			maxFiles: 1,
			uploadMultiple: false,
			acceptedFiles: 'application/pdf',
			maxFilesize: 5, // MB

			addRemoveLinks: true,
			dictDefaultMessage:
				'Arrastra aqu√≠ tu contrato firmado o haz clic para seleccionar.',
			dictRemoveFile: 'Eliminar archivo',
		});

		// Habilitar bot√≥n cuando hay archivo
		dz.on('addedfile', function (file) {
			// S√≥lo queremos un archivo
			if (dz.files.length > 1) {
				dz.removeFile(dz.files[0]); // elimina el anterior
			}

			confirmBtn.disabled = false;

			// Limpiar timeout previo si existe
			if (tempTimeoutId) clearTimeout(tempTimeoutId);

			// Programar expiraci√≥n en 2 minutos (120000 ms)
			tempTimeoutId = setTimeout(
				function () {
					dz.removeAllFiles(true);
					confirmBtn.disabled = true;
					alert('El archivo temporal ha expirado. Vuelve a subir el contrato.');
				},
				2 * 60 * 1000,
			);
		});

		// Si el usuario elimina el archivo manualmente
		dz.on('removedfile', function () {
			confirmBtn.disabled = true;
			if (tempTimeoutId) clearTimeout(tempTimeoutId);
		});

		// Bot√≥n de "Guardar contrato" ‚Üí ahora s√≠ hacemos POST
		confirmBtn.addEventListener('click', function () {
			if (dz.getQueuedFiles().length === 0) {
				return;
			}

			confirmBtn.disabled = true;

			dz.processQueue(); // üî• aqu√≠ reci√©n se hace el POST al endpoint
		});

		// Manejo de √©xito: seguir la redirecci√≥n de tu endpoint
		dz.on('success', function (file) {
			if (tempTimeoutId) clearTimeout(tempTimeoutId);

			var xhr = file.xhr;
			if (xhr && xhr.responseURL) {
				window.location.href = xhr.responseURL;
			}
		});

		dz.on('error', function (file, errorMessage) {
			console.error('Error al subir el contrato:', errorMessage);
			confirmBtn.disabled = false;
			if (tempTimeoutId) clearTimeout(tempTimeoutId);
			alert('Hubo un error al subir el contrato. Intenta de nuevo.');
		});
	});
</script>
