---
/* eslint max-lines: 'off' */

import { supabase } from '../lib/supabase';

const {
	data: { user },
} = await supabase.auth.getUser();
// JOIN: referidos -> usuarios (referido) y (opcional) partner
const { data: rows, error } = await supabase
	.from('referidos')
	.select(
		`
    id,
    code,
    created_at,
    referido:usuarios!referidos_referido_id_fkey (
      user_id, nombre, apellido, correo, avatar_url, estado
    ),
    partner:usuarios!referidos_partner_id_fkey (
      user_id, nombre, apellido, correo, avatar_url, estado
    )
  `,
	)
	.eq('partner_id', user?.id)
	.order('created_at', { ascending: false });

if (error) console.error(error);

const referidos = (rows ?? []).map((r) => ({
	user_id: r.referido?.user_id,
	nombre: r.referido?.nombre ?? '—',
	apellido: r.referido?.apellido ?? '_',
	correo: r.referido?.correo ?? '—',
	avatar: r.referido?.avatar_url ?? null,
	code: r.code,
	fecha: r.created_at,
	estado: r.referido?.estado,
}));
type Referral = {
  name: string;
  email?: string | null;
  create_date?: string;
};

let referrals: Referral[] = [];
let errorMsg = "";
let loading = true;

try {
  
  const apiUrl = new URL("/api/odoo/referrals", Astro.request.url);

  // 2) Pasar las cookies del request actual al endpoint
  const res = await fetch(apiUrl.toString(), {
    headers: {
      cookie: Astro.request.headers.get("cookie") ?? "",
    },
  });

  if (!res.ok) {
    
    errorMsg = "Sistema ERP no disponible temporalmente.";
  } else {
    const { success, data } = await res.json();

    if (!success) {
      errorMsg = "Sistema ERP no disponible temporalmente.";
    } else {
      referrals = data ?? [];
    }
  }
} catch (err) {
  errorMsg = "No se pudo conectar con el ERP.";
} finally {
  loading = false;
}

console.log(referrals);
---

<div class="px-4 pt-6">
	<div class="grid gap-4 xl:grid-cols-2 2xl:grid-cols-3">
		<!-- Main widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm 2xl:col-span-2 dark:border-gray-700 sm:p-6 dark:bg-[#1d1d1d]"
		>
			<div class="flex items-center justify-between mb-4">
				<div class="flex-shrink-0">
					<span
						class="text-xl font-bold leading-none text-gray-900 sm:text-2xl dark:text-white"
						>Referidos</span
					>
					<h3 class="text-base font-light text-gray-500 dark:text-gray-400">
						por dia
					</h3>
				</div>
			</div>

			<!-- NOTE: Charts could be extracted to a generic UI component -->
			<div id="main-chart"></div>

			<!-- Card Footer -->
			<div
				class="flex items-center justify-between pt-3 mt-4 border-t border-gray-200 sm:pt-6 dark:border-gray-700"
			>
				<div>
					<p
						class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-500 rounded-lg hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
					>
						Ultimos 10 dias
					</p>
				</div>
			</div>
		</div>
		<!--Tabs widget -->
		<div
			class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm dark:border-gray-700 sm:p-6 dark:bg-[#1d1d1d]"
		>
			<h3
				class="flex items-center mb-4 text-lg font-semibold text-gray-900 dark:text-white"
			>
				Lista de usuarios que referiste
				<button
					data-popover-target="popover-description"
					data-popover-placement="bottom-end"
					type="button"
					><svg
						class="w-4 h-4 ml-2 text-gray-400 hover:text-gray-500"
						aria-hidden="true"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z"
							clip-rule="evenodd"></path></svg
					><span class="sr-only">Mostrar información</span></button
				>
			</h3>
			<div
				data-popover
				id="popover-description"
				role="tooltip"
				class="absolute z-10 invisible inline-block text-sm font-light text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-sm opacity-0 w-72 dark:bg-[#1d1d1d] dark:border-gray-600 dark:text-gray-400"
			>
				<div class="p-3 space-y-2">
					<h3 class="font-semibold text-gray-900 dark:text-white">Referidos</h3>
					<p>Listado de todos los usuarios que usaron tu codigo de referido.</p>
					
				</div>
				<div data-popper-arrow></div>
			</div>

			<div class="p-3 space-y-2">
				<h3 class="font-semibold text-gray-900 dark:text-white">Referidos</h3>
			</div>
			<div
				id="fullWidthTabContent"
				class="border-t border-gray-200 dark:border-gray-600"
			>
				<div
					class="pt-4"
					id="about"
					role="tabpanel"
					aria-labelledby="about-tab"
				>
					<ul role="list" class="divide-y divide-gray-200 dark:divide-gray-700">
						{
							referrals?.map((r) => (
								<li class="py-3 sm:py-4">
									<div class="flex items-center space-x-4">
										<div class="flex-shrink-0">
											<img
												class="w-8 h-8 rounded-full"
												src={r.avatar_128}
												alt={`Avatar de ${r.name}`}
											/>
										</div>
										<div class="flex-1 min-w-0">
											<p class="font-medium text-gray-900 truncate dark:text-white">
												{r.name}
											</p>
											<p class="text-sm text-gray-500 truncate dark:text-gray-400">
												{r.email}
											</p>
										</div>
										<div class="inline-flex items-center text-base font-semibold text-gray-900 dark:text-white">
											{r.city}
										</div>
									</div>
								</li>
							))
						}
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	import './DashBoardpartners.client.js';
</script>

<style is:global>
	/* chart styles */
	.apexcharts-tooltip {
		@apply bg-white dark:bg-neutral-800 text-gray-500 dark:text-gray-400 border-0 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-title {
		@apply py-2 px-4 bg-gray-100 dark:bg-gray-600 border-b border-gray-200 dark:border-gray-500 !important;
	}

	.apexcharts-xaxistooltip {
		@apply text-gray-500 border-0 bg-white dark:bg-neutral-700 dark:text-gray-300 rounded-lg shadow-lg !important;
	}

	.apexcharts-tooltip .apexcharts-tooltip-text-y-value {
		@apply dark:text-white;
	}

	.apexcharts-xaxistooltip-text {
		@apply font-medium text-sm !important;
	}

	.apexcharts-xaxistooltip:before,
	.apexcharts-xaxistooltip:after {
		@apply border-0 !important;
	}
</style>
