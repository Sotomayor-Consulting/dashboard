---
import { supabase } from '../lib/supabase';
const { cookies } = Astro;

let userId = null;
let empresas: {
	user_id: any;
	empresa_incorporacion_id: any;
	tipo_de_negocio: any;
	estado_de_incorporacion: any;
	estado: any;
	nombre_1: any;
	nombre_2: any;
	nombre_3: any;
	updated_at: any;
}[] = [];

// 1) Intentar restaurar sesión si hay cookies disponibles
const at = cookies.get('sb-access-token');
const rt = cookies.get('sb-refresh-token');

if (at && rt) {
	await supabase.auth.setSession({
		access_token: at.value,
		refresh_token: rt.value,
	});

	// 2) Obtener el usuario si existe sesión
	const {
		data: { user },
		error: userErr,
	} = await supabase.auth.getUser();

	if (!userErr && user) {
		userId = user.id; // Este es el user_id (UUID) que necesitas

		// 3) Verificar si es admin
		const { data: isAdmin, error: rpcErr } = await supabase.rpc('is_admin', {
			uid: user.id,
		});

		// 4) Si NO es admin → cargar sus empresas con estado "En proceso"
		if (!rpcErr && !isAdmin) {
			const { data } = await supabase
				.from('empresas_incorporaciones')
				.select(
					`
					user_id,
					empresa_incorporacion_id,
					tipo_de_negocio,
					estado_de_incorporacion,
					estado,
					nombre_1,
					nombre_2,
					nombre_3,
					updated_at
				`,
				)
				.eq('user_id', user.id)
				.eq('estado', 'En proceso') // <- Filtro para mostrar solo "En proceso"
				.order('updated_at', { ascending: true });

			empresas = data ?? [];
		}
	}
}

// 5) Obtener los servicios activos (siempre se ejecuta, con o sin usuario)
const { data: servicios, error: serviciosErr } = await supabase
	.from('servicios')
	.select(
		`
		id_servicios,
		nombre,
		precio,
		descripcion,
		categoria,
		servicio_activo
	`,
	)
	.eq('servicio_activo', true);

if (serviciosErr) {
	console.error('Error cargando servicios:', serviciosErr);
}

const { data: paises, error: paisesErr } = await supabase
	.from('paises')
	.select('*')
	.order('nombre_paises', { ascending: true });

if (paisesErr) {
	console.error('Error cargando países:', serviciosErr);
}

// Convertir a array seguro para usar con .map()
const empresasArray = empresas || [];

// 6) Asignar cada servicio a una tarjeta específica
const planBasico = servicios?.find((s) => s.nombre === 'Plan Básico');
const planEstandar = servicios?.find((s) => s.nombre === 'Plan Estándar');
const planBusiness = servicios?.find((s) => s.nombre === 'Plan Business');
const planDiseno = servicios?.find((s) => s.nombre === 'Plan Diseño - upgrade');
---

<!-- ========== MAIN CONTENT ========== -->
<main id="content" class={userId}>
	<div class="overflow-hidden">
		<div class="pt-5 relative flex flex-col items-center h-[110vh]" id="panel1">
			<div class="max-w-2xl mx-auto text-center mb-10">
				<h3 class="text-white text-3xl">Selecciona la empresa a incorporar</h3>
			</div>
			<div
				class="flex flex-col bg-white border border-gray-200 rounded-2xl p-4 md:p-8 dark:bg-neutral-900 dark:border-neutral-800 w-full md:w-1/2 items-center"
			>
				<p
					class="mt-2 lg:text-lg text-gray-800 dark:text-neutral-200 mb-5 text-left w-full"
				>
					Lista de empresas
				</p>
				<select
					name="empresa"
					id="empresa-select"
					class="py-3 px-4 pe-9 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600 mb-5"
				>
					{
						empresasArray?.map((empresa) => (
							<option value={empresa.empresa_incorporacion_id}>
								{empresa.nombre_1}
							</option>
						))
					}
				</select>
				<button
					id="btn-paso1"
					class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-[#8c681d] text-white hover:bg-[#8c681d]/80 focus:outline-hidden focus:outline-hidden focus:bg-[#8c681d]/80 disabled:opacity-50 disabled:pointer-events-none text-center w-fit"
				>
					Continuar</button
				>
			</div>
		</div>
		<div class="relative hidden" id="panel2">
			<div
				class="max-w-[85rem] px-4 pt-5 sm:px-6 lg:px-8 lg:pt-14 mx-auto"
				id="step-plans"
			>
				<!-- Title -->
				<div class="max-w-2xl mx-auto text-center mb-10">
					<h3 class="text-white text-3xl">Escoge tu plan</h3>
					<p class="mt-2 lg:text-lg text-gray-800 dark:text-neutral-200">
						Elije el plan que mas se adapte a tu negocio y necesidades
					</p>
				</div>

				<div
					class="mt-6 md:mt-12 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6 lg:gap-3 xl:gap-6 lg:items-center grid"
					id="divActivo"
				>
					{
						planBasico && (
							<div>
								<input
									type="radio"
									id={planBasico.id_servicios}
									name="plan"
									value={planBasico.id_servicios}
									class="hidden peer"
									required
									data-price={planBasico.precio}
								/>
								<label
									for={planBasico.id_servicios}
									class="flex flex-col bg-white border border-gray-200 text-center rounded-2xl p-4 md:p-8 dark:bg-neutral-900 dark:border-neutral-800 peer-checked:border-[#8c681d] cursor-pointer"
								>
									<h4 class="font-medium text-lg text-gray-800 dark:text-neutral-200">
										{planBasico.nombre}
									</h4>
									<span class="mt-7 font-bold text-3xl md:text-4xl xl:text-5xl text-gray-800 dark:text-neutral-200">
										${planBasico.precio}
									</span>
									<p class="mt-2 text-sm text-gray-500 dark:text-neutral-500">
										{planBasico.descripcion}
									</p>
									<ul class="mt-7 space-y-2.5 text-sm">
										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Incorporación de la LLC frente al Estado.
											</span>
										</li>

										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Obtención del EIN (Número de Identificación Tributaria).
											</span>
										</li>

										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Agente Residente por un año.
											</span>
										</li>
									</ul>
								</label>
							</div>
						)
					}

					{
						planBusiness && (
							<div class="tarjeta-2">
								<input
									type="radio"
									id={planBusiness.id_servicios}
									name="plan"
									value={planBusiness.id_servicios}
									class="hidden peer"
									required
									checked
									data-price={planBusiness.precio}
								/>
								<label
									for={planBusiness.id_servicios}
									class="flex flex-col bg-white border border-gray-200 text-center rounded-2xl p-4 md:p-8 dark:bg-neutral-900 dark:border-neutral-800 peer-checked:border-[#8c681d] cursor-pointer"
								>
									<p class="mb-3">
										<span class="inline-flex items-center gap-1.5 py-1.5 px-3 rounded-lg text-xs uppercase font-semibold bg-violet-100 text-[#8c681d] dark:bg-[#8c681d] dark:text-white animate-pulse">
											Más popular
										</span>
									</p>
									<h4 class="font-medium text-lg text-gray-800 dark:text-neutral-200">
										{planBusiness.nombre}
									</h4>
									<span class="mt-7 font-bold text-3xl md:text-4xl xl:text-5xl text-gray-800 dark:text-neutral-200">
										${planBusiness.precio}
									</span>
									<p class="mt-2 text-sm text-gray-500 dark:text-neutral-500">
										{planBusiness.descripcion}
									</p>

									<ul class="mt-7 space-y-2.5 text-sm">
										<li class="flex gap-x-2">
											<span class="text-gray-800 dark:text-neutral-300 text-left">
												Los beneficios del plan básico y Los beneficios del plan
												estándar, más:
											</span>
										</li>
										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												viewBox="0 0 24 24"
												fill="currentColor"
												clip-rule="evenodd"
												fill-rule="evenodd"
											>
												<>
													<title />
													<path
														d="m12 17.275l-4.15 2.5q-.275.175-.575.15t-.525-.2t-.35-.437t-.05-.588l1.1-4.725L3.775 10.8q-.25-.225-.312-.513t.037-.562t.3-.45t.55-.225l4.85-.425l1.875-4.45q.125-.3.388-.45t.537-.15t.537.15t.388.45l1.875 4.45l4.85.425q.35.05.55.225t.3.45t.038.563t-.313.512l-3.675 3.175l1.1 4.725q.075.325-.05.588t-.35.437t-.525.2t-.575-.15z"
														class=""
													/>
												</>
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Planificación y diseño de LLC
											</span>
										</li>

										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												viewBox="0 0 16 16"
												fill="currentColor"
												clip-rule="evenodd"
												fill-rule="evenodd"
											>
												<>
													<title />
													<path
														d="M7.194 2.101a.9.9 0 0 1 1.614 0l1.521 3.082l3.401.495a.9.9 0 0 1 .5 1.535l-2.462 2.399l.581 3.387a.9.9 0 0 1-1.306.949l-3.042-1.6l-3.042 1.6a.9.9 0 0 1-1.306-.949l.58-3.387l-2.46-2.4a.9.9 0 0 1 .499-1.534l3.4-.495zM8 2.726L6.546 5.673a.9.9 0 0 1-.677.492l-3.253.473L4.97 8.932a.9.9 0 0 1 .258.797l-.555 3.24l2.91-1.53a.9.9 0 0 1 .837 0l2.91 1.53l-.556-3.24a.9.9 0 0 1 .258-.797l2.354-2.294l-3.253-.473a.9.9 0 0 1-.677-.492z"
														class=""
													/>
												</>
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Servicio de acompañamiento para abrir tu cuenta bancaria
												Online.
											</span>
										</li>
									</ul>
								</label>
							</div>
						)
					}

					{
						planEstandar && (
							<div class="tarjeta-3">
								<input
									type="radio"
									id={planEstandar.id_servicios}
									name="plan"
									value={planEstandar.id_servicios}
									class="hidden peer"
									required
									data-price={planEstandar.precio}
								/>
								<label
									for={planEstandar.id_servicios}
									class="flex flex-col bg-white border border-gray-200 text-center rounded-2xl p-4 md:p-8 dark:bg-neutral-900 dark:border-neutral-800 peer-checked:border-[#8c681d] cursor-pointer"
								>
									<h4 class="font-medium text-lg text-gray-800 dark:text-neutral-200">
										{planEstandar.nombre}
									</h4>
									<span class="mt-7 font-bold text-3xl md:text-4xl xl:text-5xl text-gray-800 dark:text-neutral-200">
										${planEstandar.precio}
									</span>
									<p class="mt-2 text-sm text-gray-500 dark:text-neutral-500">
										{planEstandar.descripcion}
									</p>

									<ul class="mt-7 space-y-2.5 text-sm">
										<li class="flex gap-x-2">
											<span class="text-gray-800 dark:text-neutral-300 text-left">
												Los beneficios del Plan Básico más:
											</span>
										</li>

										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Elaboración del Acuerdo de Operación.
											</span>
										</li>

										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Consultas ilimitadas por un año.
											</span>
										</li>
										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Reporte BOI
											</span>
										</li>
									</ul>
								</label>
							</div>
						)
					}
				</div>

				<div
					class="mt-6 md:mt-12 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-6 lg:gap-3 xl:gap-6 lg:items-center diseño-contenedor grid"
					id="divInactivo"
				>
					{
						planDiseno && (
							<div class="col-start-2 tarjeta-4">
								<input
									type="radio"
									id={planDiseno.id_servicios}
									name="plan"
									value={planDiseno.id_servicios}
									class="hidden peer"
									required
									data-price={planDiseno.precio}
								/>
								<label
									for={planDiseno.id_servicios}
									class="flex flex-col bg-white border border-gray-200 text-center rounded-2xl p-4 md:p-8 dark:bg-neutral-900 dark:border-neutral-800 peer-checked:border-[#8c681d] cursor-pointer"
								>
									<div class="col-span-2 mt-2">
										<button
											class="flex items-end justify-end h-full place-self-end dark:text-white text-neutral-700"
											data-popover-target="popover-description4"
											data-popover-placement="bottom-end"
											type="button"
										>
											<svg
												xmlns="http://www.w3.org/2000/svg"
												width="20"
												height="20"
												viewBox="0 0 24 24"
											>
												<g fill="none">
													<>
														<path d="m12.593 23.258l-.011.002l-.071.035l-.02.004l-.014-.004l-.071-.035q-.016-.005-.024.005l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.017-.018m.265-.113l-.013.002l-.185.093l-.01.01l-.003.011l.018.43l.005.012l.008.007l.201.093q.019.005.029-.008l.004-.014l-.034-.614q-.005-.018-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.004-.011l.017-.43l-.003-.012l-.01-.01z" />
														<path
															fill="currentColor"
															d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2m0 14a1 1 0 1 0 0 2a1 1 0 0 0 0-2m0-9.5a3.625 3.625 0 0 0-3.625 3.625a1 1 0 1 0 2 0a1.625 1.625 0 1 1 2.23 1.51c-.676.27-1.605.962-1.605 2.115V14a1 1 0 1 0 2 0c0-.244.05-.366.261-.47l.087-.04A3.626 3.626 0 0 0 12 6.5"
														/>
													</>
												</g>
											</svg>
										</button>
									</div>

									<div
										data-popover
										id="popover-description4"
										role="tooltip"
										class="absolute z-10 invisible inline-block text-sm text-gray-500 transition-opacity duration-300 bg-white border border-gray-200 rounded-lg shadow-xs opacity-0 w-72 dark:bg-neutral-800 dark:border-gray-600 dark:text-gray-400"
									>
										<div class="p-3 space-y-2">
											<h3 class="font-semibold text-gray-900 dark:text-white">
												¿Que es el plan de diseño - upgrade?
											</h3>
											<p class="grid grid-cols-[auto,1fr] items-center">
												<span>
													Este plan está meticulosamente creado para las
													empresas que requieren una LLC totalmente
													personalizada, recibiendo asesoría experta que alinea
													su estructura con su modelo de negocio y sus
													requerimientos específicos. Además, su diseño permite
													escalar o actualizar a otros planes superiores,
													facilitando la construcción progresiva y paso a paso
													de su estructura de LLC.
												</span>
											</p>
										</div>
										<div data-popper-arrow />
									</div>
									<h4 class="font-medium text-lg text-gray-800 dark:text-neutral-200">
										{planDiseno.nombre}
									</h4>
									<span class="mt-7 font-bold text-3xl md:text-4xl xl:text-5xl text-gray-800 dark:text-neutral-200">
										${planDiseno.precio}
									</span>
									<p class="mt-2 text-sm text-gray-500 dark:text-neutral-500">
										{planDiseno.descripcion}
									</p>

									<ul class="mt-7 space-y-2.5 text-sm">
										<li class="flex gap-x-2">
											<svg
												class="shrink-0 mt-0.5 size-4 text-[#8c681d]"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												viewBox="0 0 24 24"
												fill="none"
												stroke="currentColor"
												stroke-width="2"
												stroke-linecap="round"
												stroke-linejoin="round"
											>
												<polyline points="20 6 9 17 4 12" />
											</svg>
											<span class="text-gray-800 dark:text-neutral-400 text-left">
												Planificación y diseño de LLC
											</span>
										</li>
									</ul>
								</label>
							</div>
						)
					}
				</div>

				<div
					class="w-2/3 sm:w-1/2 lg:w-1/3 mx-auto text-center mt-10 md:mt-14 mb-6"
				>
					<div class="mb-3">
						<button
							type="button"
							id="btn-continue"
							class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-[#8c681d] text-white hover:bg-[#8c681d]/80 focus:outline-hidden focus:outline-hidden focus:bg-[#8c681d]/80 disabled:opacity-50 disabled:pointer-events-none"
						>
							Continuar con el pago
						</button>
					</div>
					<div>
						<button
							type="button"
							id="btn-atras"
							class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-zinc-500 text-white hover:bg-zinc-600 focus:outline-hidden focus:outline-hidden focus:bg-[#8c681d]/80 disabled:opacity-50 disabled:pointer-events-none"
						>
							Regresar
						</button>
					</div>
				</div>
			</div>

			<div id="step-payment" class="hidden grid md:grid-cols-2">
				<div
					class="md:w-4/5 w-full mx-auto mt-10 mb-16 bg-white/80 dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-2xl p-6 shadow-sm place-self-center justify-self-center md:row-start-1 row-start-2"
				>
					<div
						id="stripe-config"
						data-pk={import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY}
						data-id={userId}
						class="hidden"
					>
					</div>
					<h3
						class="text-xl font-semibold text-gray-800 dark:text-neutral-100 mb-2"
					>
						Completa tu pago
					</h3>
					<p
						class="text-base text-gray-600 dark:text-neutral-400 mb-4"
						id="selected-plan-summary"
					>
						Estás pagando el plan seleccionado.
					</p>

					<form id="payment-form" class="space-y-4">
						<div>
							<label
								class="block text-sm font-medium text-gray-700 dark:text-neutral-300 mb-1"
							>
								Datos de la tarjeta
							</label>
							<div
								id="card-element"
								class="p-3 border border-gray-300 dark:border-neutral-700 rounded-lg bg-white dark:bg-neutral-800"
							>
							</div>
							<p id="card-errors" class="text-sm text-red-500 mt-2"></p>
						</div>
						<p
							id="status-message"
							class="text-sm text-gray-600 dark:text-neutral-300"
						>
						</p>

						<div class="flex flex-col">
							<div class="flex mb-2">
								<div class="flex items-center h-5">
									<input
										id="factura-checkbox"
										aria-describedby="helper-checkbox-text"
										type="checkbox"
										value="si"
										class="w-4 h-4 border border-default-medium rounded-xs bg-neutral-secondary-medium focus:ring-2 focus:ring-brand-soft"
									/>
								</div>
								<div
									class="ms-2 text-sm select-none text-gray-700 dark:text-neutral-300"
								>
									<label
										for="factura-checkbox"
										class="font-medium text-heading"
									>
										Incluir datos para facturación
									</label>
									<p
										id="helper-checkbox-text"
										class="text-xs font-normal text-body"
									>
										Selecciona esta opción si deseas que te emitamos una factura
										con los datos que nos proporciones.
									</p>
								</div>
							</div>

							<div
								id="contenedor-facturacion"
								class="mt-2 border-t border-neutral-600 hidden"
							>
								<div class="text-gray-700 dark:text-neutral-300 mt-3">
									<h4 class="text-lg font-bold">Datos de facturación</h4>
									<p>Ingrese los datos que se incluirán en tu factura.</p>
								</div>

								<!-- Personería -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-5"
								>
									<div class="mb-2">
										<label class="block mb-2.5 text-sm text-heading font-bold"
											>Personería</label
										>
									</div>
									<div class="flex gap-5">
										<div class="flex items-center mr-2">
											<input
												id="bill-legal-natural"
												type="radio"
												value="natural"
												name="bill-legal-type"
												data-billing="true"
												class="w-4 h-4 text-neutral-primary border-default-medium bg-neutral-secondary-medium rounded-full checked:border-brand focus:ring-2 focus:outline-none focus:ring-brand-subtle border border-default appearance-none"
											/>
											<label
												for="bill-legal-natural"
												class="select-none ms-2 text-sm font-medium text-heading"
											>
												Persona Natural
											</label>
										</div>
										<div class="flex items-center ml-2">
											<input
												id="bill-legal-juridica"
												type="radio"
												value="juridica"
												name="bill-legal-type"
												data-billing="true"
												checked
												class="w-4 h-4 text-neutral-primary border-default-medium bg-neutral-secondary-medium rounded-full checked:border-brand focus:ring-2 focus:outline-none focus:ring-brand-subtle border border-default appearance-none"
											/>
											<label
												for="bill-legal-juridica"
												class="select-none ms-2 text-sm font-medium text-heading"
											>
												Persona Jurídica
											</label>
										</div>
									</div>
								</div>

								<!-- Nombre/Razón social -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-4"
								>
									<div>
										<label
											for="bill-razon"
											class="block mb-2.5 text-sm text-heading font-bold"
										>
											Nombre o Razón Social
										</label>
										<input
											type="text"
											id="bill-razon"
											data-billing="true"
											class="bg-neutral-800 border text-heading text-sm rounded-md focus:ring-[#8c681d] focus:border-[#8c681d] w-full px-3 py-2.5 shadow-xs placeholder:text-neutral-500"
											placeholder="Nombre y Apellido o Razón Social"
										/>
										<p class="text-xs">
											Ingresa tu nombre o la razón social de tu empresa.
										</p>
									</div>
								</div>

								<!-- Email -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-4"
								>
									<div>
										<label
											for="bill-email"
											class="block mb-2.5 text-sm text-heading font-bold"
										>
											Correo electrónico
										</label>
										<input
											type="email"
											id="bill-email"
											data-billing="true"
											class="bg-neutral-800 border text-heading text-sm rounded-md focus:ring-[#8c681d] focus:border-[#8c681d] w-full px-3 py-2.5 shadow-xs placeholder:text-neutral-500"
											placeholder="ejemplo@email.com"
										/>
										<p class="text-xs">Se usará para enviarte la factura.</p>
									</div>
								</div>

								<!-- Teléfono (código + número) -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-4"
								>
									<div>
										<label
											for="bill-phone"
											class="block mb-2.5 text-sm text-heading font-bold"
										>
											Teléfono
										</label>
										<div class="relative">
											<input
												type="text"
												id="bill-phone"
												data-billing="true"
												class="block w-full rounded-lg border-gray-200 px-4 py-2.5 ps-40 focus:z-10 focus:border-[#ba8d34] focus:ring-[#ba8d34] disabled:pointer-events-none disabled:opacity-50 sm:py-3 sm:text-sm dark:border-neutral-700 dark:bg-neutral-800 dark:text-white dark:placeholder-neutral-400 dark:focus:ring-neutral-600"
												placeholder="(000) 000-0000"
											/>
											<div
												class="absolute inset-y-0 start-0 flex items-center ps-px text-gray-500 overflow-hidden w-1/5 p-1"
											>
												<label for="bill-phone-country" class="sr-only"
													>País</label
												>
												<select
													id="bill-phone-country"
													data-billing="true"
													class="block rounded-lg border-transparent focus:border-[#ba8d34] focus:ring-[#ba8d34] dark:bg-neutral-800 dark:text-neutral-500 w-full text-xs dark:border-neutral-700"
												>
													{
														paises?.map((p) => (
															<option
																data-countrycode={p.iso}
																value={`+${p.codigo_telf}`}
															>
																{p.nombre_paises}
															</option>
														))
													}
												</select>
											</div>
										</div>
										<p class="text-xs">
											Solo números, sin espacios ni caracteres especiales.
										</p>
									</div>
								</div>

								<!-- Documento de identidad -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-4"
								>
									<div>
										<label
											for="bill-id-number"
											class="block mb-2.5 text-sm text-heading font-bold"
										>
											Documento de Identidad
										</label>
										<div class="relative">
											<input
												type="text"
												id="bill-id-number"
												data-billing="true"
												class="block w-full rounded-lg border-gray-200 px-4 py-2.5 ps-36 focus:z-10 focus:border-[#ba8d34] focus:ring-[#ba8d34] disabled:pointer-events-none disabled:opacity-50 sm:py-3 sm:text-sm dark:border-neutral-700 dark:bg-neutral-800 dark:text-white dark:placeholder-neutral-400 dark:focus:ring-neutral-60"
												placeholder="Número"
											/>
											<div
												class="absolute inset-y-0 start-0 flex items-center ps-px text-gray-500"
											>
												<label for="bill-id-type" class="sr-only">Tipo</label>
												<select
													id="bill-id-type"
													data-billing="true"
													class="block w-fit rounded-lg border-transparent focus:border-[#ba8d34] focus:ring-[#ba8d34] dark:bg-neutral-800 dark:text-neutral-500 dark:border-neutral-700"
												>
													<option value="Cedula">Cédula</option>
													<option value="RUC">RUC</option>
													<option value="ID">ID</option>
													<option value="Pasaporte">Pasaporte</option>
													<option value="EIN">EIN</option>
												</select>
											</div>
										</div>
									</div>
								</div>

								<!-- Dirección -->
								<div
									class="flex text-gray-700 dark:text-neutral-300 flex-col mt-4 border-b border-neutral-600"
								>
									<div class="mb-5">
										<label
											for="bill-address1"
											class="block mb-2.5 text-sm text-heading font-bold"
										>
											Dirección
										</label>
										<div class="grid grid-cols-2 gap-3">
											<input
												type="text"
												id="bill-address1"
												data-billing="true"
												class="block w-full rounded-lg border-gray-200 px-4 py-2.5 focus:border-[#ba8d34] focus:ring-[#ba8d34] disabled:pointer-events-none disabled:opacity-50 sm:py-3 sm:text-sm dark:border-neutral-700 dark:bg-neutral-800 dark:text-white dark:placeholder-neutral-400 dark:focus:ring-neutral-60 col-span-2"
												placeholder="Dirección línea 1"
											/>
											<input
												type="text"
												id="bill-city"
												data-billing="true"
												class="block w-full rounded-lg border-gray-200 px-4 py-2.5 focus:border-[#ba8d34] focus:ring-[#ba8d34] disabled:pointer-events-none disabled:opacity-50 sm:py-3 sm:text-sm dark:border-neutral-700 dark:bg-neutral-800 dark:text-white dark:placeholder-neutral-400 dark:focus:ring-neutral-60"
												placeholder="Ciudad"
											/>
											<select
												id="bill-country"
												data-billing="true"
												class="block rounded-lg border-transparent focus:border-[#ba8d34] focus:ring-[#ba8d34] dark:bg-neutral-800 dark:text-neutral-400 w-full text-sm dark:border-neutral-700"
											>
												<option value="" selected disabled
													>Selecciona un país</option
												>
												{
													paises?.map((p) => (
														<option
															value={p.nombre_paises}
															data-countryCode={p.iso}
															data-dial={`+${p.codigo_telf}`}
														>
															{p.nombre_paises}
														</option>
													))
												}
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>

						<button
							type="submit"
							id="pay-button"
							class="w-full py-3 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-[#8c681d] text-white hover:bg-[#8c681d]/80 focus:outline-hidden disabled:opacity-50 disabled:pointer-events-none"
						>
							Pagar ahora
						</button>

						<button
							type="button"
							id="btn-back"
							class="w-full py-2 px-4 mt-2 inline-flex justify-center items-center gap-x-2 text-xs font-medium rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 dark:bg-neutral-900 dark:text-neutral-200 dark:border-neutral-700"
						>
							Volver a elegir plan
						</button>
					</form>
				</div>

				<div class="grow mt-10 mb-16 md:w-3/5 w-full">
					<div
						id="price-summary"
						class="space-y-4 rounded-lg border border-gray-100 bg-gray-50 p-6 dark:border-gray-700 dark:bg-neutral-900"
					>
						<div class="space-y-2">
							<dl class="flex items-center justify-between gap-4">
								<dt
									class="text-base font-normal text-gray-500 dark:text-gray-400"
								>
									Precio del plan
								</dt>
								<dd
									id="summary-base"
									class="text-base font-medium text-gray-900 dark:text-white"
								>
									$0.00
								</dd>
							</dl>

							<dl class="flex items-center justify-between gap-4">
								<dt
									class="text-base font-normal text-gray-500 dark:text-gray-400"
								>
									Tarifas de procesamiento
								</dt>
								<dd
									id="summary-fee"
									class="text-base font-medium text-gray-900 dark:text-white"
								>
									$0.00
								</dd>
							</dl>
						</div>

						<dl
							class="flex items-center justify-between gap-4 border-t border-gray-200 pt-2 dark:border-gray-700"
						>
							<dt class="text-base font-bold text-gray-900 dark:text-white">
								Total
							</dt>
							<dd
								id="summary-total"
								class="text-base font-bold text-gray-900 dark:text-white"
							>
								$0.00
							</dd>
						</dl>
					</div>

					<div class="mt-6 flex items-center justify-center gap-2">
						<p class="text-base font-normal text-gray-500 dark:text-gray-400">
							Pago seguro gestionado por:
						</p>
						<img
							class="hidden h-10 w-auto dark:flex"
							src="/src/assets/stripe.svg"
							alt=""
						/>
					</div>
				</div>
			</div>
		</div>
	</div>
</main>

<script src="https://js.stripe.com/v3/"></script>

<script is:inline>
	document.addEventListener('DOMContentLoaded', () => {
		// --- NUEVO: toggle de facturación (mostrar/ocultar y required) ---
		const facturaCheckbox = document.getElementById('factura-checkbox');
		const contFacturacion = document.getElementById('contenedor-facturacion');
		function setBillingRequired(on) {
			if (!contFacturacion) return;
			const fields = contFacturacion.querySelectorAll(
				'input, select, textarea',
			);
			fields.forEach((el) => {
				el.required = !!on;
			});
		}
		if (facturaCheckbox && contFacturacion) {
			// estado inicial
			contFacturacion.classList.toggle('hidden', !facturaCheckbox.checked);
			setBillingRequired(facturaCheckbox.checked);
			// cambio
			facturaCheckbox.addEventListener('change', () => {
				const on = facturaCheckbox.checked;
				contFacturacion.classList.toggle('hidden', !on);
				setBillingRequired(on);
			});
		}
		// --- FIN NUEVO ---

		// 1) Config Stripe
		const cfg = document.getElementById('stripe-config');
		if (!cfg) {
			console.error('Stripe config div not found');
			return;
		}
		const pk = cfg.dataset.pk;
		const userId = cfg.dataset.id; // user_id del dataset
		if (!pk || !userId) {
			console.error('Stripe publishable key or user ID missing');
			return;
		}

		// 2) Inicializar Stripe y Elements
		const stripe = Stripe(pk);
		const elements = stripe.elements();
		const cardElement = elements.create('card', {
			hidePostalCode: true,
			style: {
				base: {
					color: '#f9fafb',
					fontFamily:
						'"Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
					fontSize: '14px',
					'::placeholder': { color: '#9ca3af' },
					iconColor: '#facc15',
				},
				invalid: { color: '#f97373', iconColor: '#f97373' },
			},
		});
		cardElement.mount('#card-element');

		// 3) DOM refs
		const btnContinue = document.getElementById('btn-continue');
		const btnBack = document.getElementById('btn-back');
		const stepPlans = document.getElementById('step-plans');
		const stepPayment = document.getElementById('step-payment');
		const paymentForm = document.getElementById('payment-form');
		const cardErrors = document.getElementById('card-errors');
		const statusMessage = document.getElementById('status-message');
		const payButton = document.getElementById('pay-button');
		const planSummary = document.getElementById('selected-plan-summary');

		// Resumen de precios
		const baseEl = document.getElementById('summary-base');
		const feeEl = document.getElementById('summary-fee');
		const totalEl = document.getElementById('summary-total');

		// selector de empresa (ya existía)
		const empresaSelect = document.getElementById('empresa-select');

		let currentClientSecret = null;

		// Helpers selección plan/empresa
		function getSelectedPlan() {
			const radio = document.querySelector('input[name="plan"]:checked');
			if (!radio) return null;
			const label = radio.closest('label') || radio.parentElement;
			const titleEl = label ? label.querySelector('h4') : null;
			const rawPrice = radio.dataset.price;
			const price = rawPrice ? parseFloat(rawPrice) : NaN;
			return {
				id: radio.value,
				label: titleEl ? titleEl.textContent.trim() : 'Plan seleccionado',
				price,
			};
		}
		function getSelectedEmpresaId() {
			if (!empresaSelect) return null;
			const v = empresaSelect.value;
			return v && v.length ? v : null;
		}
		function getSelectedEmpresaLabel() {
			if (!empresaSelect) return null;
			const opt = empresaSelect.options[empresaSelect.selectedIndex];
			return opt ? opt.textContent.trim() : null;
		}

		// Resumen precios
		function formatUSD(amount) {
			if (!Number.isFinite(amount)) return '$0.00';
			return '$' + amount.toFixed(2);
		}
		function updatePriceSummary(plan) {
			if (!plan || !Number.isFinite(plan.price)) {
				baseEl.textContent = '$0.00';
				feeEl.textContent = '$0.00';
				totalEl.textContent = '$0.00';
				return;
			}
			const base = plan.price;
			const feePercent = 0.045;
			const fee = base * feePercent;
			const total = base + fee;
			baseEl.textContent = formatUSD(base);
			feeEl.textContent = formatUSD(fee);
			totalEl.textContent = formatUSD(total);
		}

		// Crear PaymentIntent (manda empresaId)
		async function createPaymentIntent(planId, userId, empresaId) {
			statusMessage.textContent = 'Preparando el pago...';
			payButton.disabled = true;
			try {
				const res = await fetch('/api/payment/payment-intent', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ planId, userId, empresaId }),
				});
				const data = await res.json();
				if (!res.ok || !data.clientSecret)
					throw new Error(data.error || 'Error al crear el pago');
				currentClientSecret = data.clientSecret;
				statusMessage.textContent = 'Ingresa los datos de tu tarjeta.';
			} catch (err) {
				console.error(err);
				statusMessage.textContent =
					'No se pudo preparar el pago. Intenta nuevamente.';
			} finally {
				payButton.disabled = false;
			}
		}

		// --- NUEVO: recolectar datos de facturación con TUS IDs actuales ---
		function getBillingPayload() {
			const personaEl = document.querySelector(
				'input[name="bill-legal-type"]:checked',
			);
			return {
				userId,
				empresaId: getSelectedEmpresaId(),
				persona: personaEl ? personaEl.value : '', // "natural" | "juridica"
				nombre_razon:
					document.getElementById('bill-razon')?.value?.trim() || '',
				email: document.getElementById('bill-email')?.value?.trim() || '',
				telefono_codigo:
					document.getElementById('bill-phone-country')?.value || '', // ej. "+593"
				telefono_numero:
					document.getElementById('bill-phone')?.value?.trim() || '',
				id_tipo: document.getElementById('bill-id-type')?.value || '', // "Cedula", "RUC", etc.
				id_numero:
					document.getElementById('bill-id-number')?.value?.trim() || '',
				direccion:
					document.getElementById('bill-address1')?.value?.trim() || '',
				ciudad: document.getElementById('bill-city')?.value?.trim() || '',
				pais: document.getElementById('bill-country')?.value || '', // ISO del país
			};
		}
		async function enviarFacturacion(payload) {
			try {
				const res = await fetch('/api/facturacion/upsert', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload),
				});
				const data = await res.json();
				if (!res.ok) {
					console.error('[Billing] error:', data);
					return false;
				}
				return true;
			} catch (e) {
				console.error('[Billing] network error:', e);
				return false;
			}
		}
		// --- FIN NUEVO ---

		// 7) Continuar con el pago
		if (btnContinue) {
			btnContinue.addEventListener('click', async () => {
				const plan = getSelectedPlan();
				if (!plan) {
					alert('Por favor selecciona un plan antes de continuar.');
					return;
				}
				const empresaId = getSelectedEmpresaId();
				if (!empresaId) {
					alert('Por favor selecciona la empresa para la que vas a pagar.');
					return;
				}
				const empresaLabel = getSelectedEmpresaLabel();

				const empresaInfo = empresaLabel ? ` | Empresa: ${empresaLabel}` : '';
				planSummary.textContent = `Estás pagando: ${plan.label}${empresaInfo}`;

				updatePriceSummary(plan);
				await createPaymentIntent(plan.id, userId, empresaId);

				stepPlans.classList.add('hidden');
				stepPayment.classList.remove('hidden');
			});
		}

		// 8) Volver a elegir plan
		if (btnBack) {
			btnBack.addEventListener('click', () => {
				stepPayment.classList.add('hidden');
				stepPlans.classList.remove('hidden');
				statusMessage.textContent = '';
				cardErrors.textContent = '';
			});
		}

		// 9) Submit del pago (facturación opcional, sin tocar tu verificación)
		if (paymentForm) {
			paymentForm.addEventListener('submit', async (event) => {
				event.preventDefault();

				if (!currentClientSecret) {
					statusMessage.textContent =
						'El pago no está listo. Vuelve a intentar (elige el plan de nuevo).';
					return;
				}

				payButton.disabled = true;
				statusMessage.textContent = 'Procesando pago...';
				cardErrors.textContent = '';

				try {
					const { error, paymentIntent } = await stripe.confirmCardPayment(
						currentClientSecret,
						{ payment_method: { card: cardElement } },
					);

					if (error) {
						console.error(error);
						cardErrors.textContent =
							error.message || 'Error al procesar el pago.';
						statusMessage.textContent =
							'No se pudo completar el pago. Intenta nuevamente.';
						payButton.disabled = false;
						return;
					}

					if (paymentIntent && paymentIntent.status === 'succeeded') {
						statusMessage.textContent =
							'Pago realizado con éxito. Registrando la información...';

						// --- NUEVO: si el checkbox está marcado, envía facturación (no bloquea) ---
						if (facturaCheckbox && facturaCheckbox.checked) {
							const billingPayload = getBillingPayload();
							// añade el payment_intent_id para relacionar en tu tabla
							billingPayload.payment_intent_id = paymentIntent.id;
							const okBilling = await enviarFacturacion(billingPayload);
							if (!okBilling) {
								console.warn(
									'No se pudo guardar la facturación (se continuará con el registro del pago).',
								);
							}
						}
						// --- FIN NUEVO ---

						// Registrar el pago en tu backend → Supabase (RPC)
						try {
							const res = await fetch('/api/payment/register', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({ paymentIntentId: paymentIntent.id }),
							});
							const data = await res.json();
							if (!res.ok) {
								console.error('Error registrando pago en BD:', data);
								statusMessage.textContent =
									'El pago se realizó, pero hubo un problema registrándolo internamente. Nuestro equipo lo revisará.';
								// NO redirigir si hay error
								payButton.disabled = false;
								return;
							} else {
								console.log('Pago registrado en BD:', data);
								statusMessage.textContent =
									'Pago realizado con éxito. Estamos iniciando el proceso de incorporación de tu LLC.';
							}
						} catch (err) {
							console.error('Error llamando a /api/payment/register:', err);
							statusMessage.textContent =
								'El pago se realizó, pero hubo un error al registrarlo internamente. Nuestro equipo lo revisará.';
							payButton.disabled = false;
							return; // NO redirigir
						}

						// Redirigir solo si todo fue OK
						window.location.href = '/pages/companias';
					} else {
						statusMessage.textContent =
							'No se pudo completar el pago. Intenta nuevamente.';
						payButton.disabled = false;
					}
				} catch (err) {
					console.error(err);
					statusMessage.textContent = 'Ocurrió un error al procesar el pago.';
					payButton.disabled = false;
				}
			});
		}
	});
</script>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const boton = document.getElementById('btn-paso1');
		const regresar = document.getElementById('btn-atras');
		const div2 = document.getElementById('panel2');
		const div1 = document.getElementById('panel1');

		boton?.addEventListener('click', function () {
			div1?.classList.add('hidden');
			div2?.classList.remove('hidden');
		});

		regresar?.addEventListener('click', function () {
			div2?.classList.add('hidden');
			div1?.classList.remove('hidden');
		});
	});
</script>
<script is:inline>
	document.addEventListener('DOMContentLoaded', function () {
		const countrySelect = document.getElementById('bill-phone-country');
		const phoneInput = document.getElementById('bill-phone');

		// Función para actualizar el código de país
		function updateCountryCode() {
			const selectedCountryCode = countrySelect.value;
			const currentPhoneValue = phoneInput.value;

			// Si el valor actual ya empieza con un código de país, lo eliminamos
			const phoneWithoutCode = currentPhoneValue.replace(/^\+\d+\s?/, '');

			// Añadimos el nuevo código de país
			phoneInput.value = selectedCountryCode + ' ' + phoneWithoutCode;
		}

		// Actualizar cuando cambie la selección
		countrySelect.addEventListener('change', updateCountryCode);

		// Actualizar al cargar la página
		updateCountryCode();
	});
</script>
