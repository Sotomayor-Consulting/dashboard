---
// src/pages/envios/[id].astro
import { supabase } from '../../../lib/supabase';

// /envios/[id]  -> id = submission_id
const { id } = Astro.params;
const { cookies, redirect } = Astro;

// 1) Sesión
const at = cookies.get('sb-access-token');
const rt = cookies.get('sb-refresh-token');
if (!at || !rt) return redirect('/sign-in');

await supabase.auth.setSession({
	access_token: at.value,
	refresh_token: rt.value,
});

// 2) Usuario
const {
	data: { user },
	error: userErr,
} = await supabase.auth.getUser();
if (userErr || !user) return redirect('/sign-in');

// 3) Traer envío y verificar rol admin (en paralelo)
const [envioRes, adminRes] = await Promise.all([
	supabase
		.from('formularios_envios')
		.select(
			`
      submission_id,
      form_id,
      user_id,
      status,
      data_json,
      schema_snapshot,
      created_at,
      submitted_at,
      empresa_incorporacion_id,
      formularios:formularios ( titulo, tema_json ),
      usuarios:usuarios ( nombre, apellido )
    `,
		)
		.eq('submission_id', id)
		.single(),
	supabase.rpc('is_admin', { uid: user.id }),
]);

const { data: envio, error: envioErr } = envioRes;
const { data: isAdmin, error: rpcErr } = adminRes;

if (envioErr || !envio) return redirect('/');

// 4) Gate: dueño o admin
const esAdmin = !rpcErr && !!isAdmin;
const canEdit = esAdmin;
if (!esAdmin && envio.user_id !== user.id) return redirect('/');

// 5) Accesos directos
const titulo = envio.formularios?.titulo;
const themeJson = envio.formularios?.tema_json;
const autorNombre = envio.usuarios?.nombre;
const apellido = envio.usuarios?.apellido;

const schemaSnapshot = envio.schema_snapshot ?? {};
const answers = envio.data_json ?? {};
const empresa_id = envio.empresa_incorporacion_id;

import '/src/estilos/surveyjs.css';
---

<!doctype html>
<html>
	<head>
		<title>{titulo} Respuestas de {autorNombre} {apellido}</title>
		<meta charset="utf-8" />
		<script
			type="text/javascript"
			src="https://unpkg.com/survey-core@2.3.9/survey.core.min.js"></script>
		<script
			type="text/javascript"
			src="https://unpkg.com/survey-js-ui@2.3.9/survey-js-ui.min.js"></script>
	</head>
	<body class="bg-neutral-700">
		<section class="mx-auto p-4 space-y-2">
			<h1 class="text-2xl font-bold text-white">
				{
					autorNombre || apellido
						? `Respuestas de ${autorNombre ?? ''} ${apellido ?? ''}`.trim()
						: 'Respuestas'
				}
			</h1>
		</section>

		<div id="surveyContainer" class="mx-auto p-4"></div>
	</body>
</html>
<script
	type="module"
	define:vars={{ schemaSnapshot, answers, themeJson, id, empresa_id, canEdit }}
>
	const survey = new Survey.Model(schemaSnapshot);

	survey.data = answers ?? {};
	survey.showCompletedPage = false;

	// Para Ops: no borres valores invisibles; backend decide qué aplica
	survey.clearInvisibleValues = 'none';

	if (typeof themeJson !== 'undefined' && themeJson) {
		survey.applyTheme(themeJson);
	}

	if (!canEdit) {
		survey.mode = 'display';
	} else {
		// editable
		survey.mode = 'edit';
		survey.completeText = 'Validar';
	}

	// Solo si puede editar, mandamos a endpoint
	if (canEdit) {
		survey.onComplete.add(async (sender) => {
			const payload = {
				submission_id: id,
				empresa_id: empresa_id,
				form_id: envio.form_id, // opcional pero útil si manejas distintos formularios
				approved_data: sender.data,
			};

			try {
				const res = await fetch(
					'/api/operaciones/validacion_de_incorporacion',
					{
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload),
					},
				);

				const out = await res.json().catch(() => ({}));

				if (!res.ok || out.ok === false) {
					console.error('Validation error:', out);
					alert('No se pudo validar. Revise los errores.');
					return;
				}

				alert('Validación enviada.');
				// opcional: redirigir o refrescar
				// window.location.reload();
			} catch (e) {
				console.error(e);
				alert('Error enviando validación.');
			}
		});
	}

	survey.render(document.getElementById('surveyContainer'));
</script>
