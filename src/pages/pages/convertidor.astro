---
// src/pages/index.astro
---

<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Convertidor DOCX a HTML para PDF</title>
		<style>
			body {
				font-family: system-ui, sans-serif;
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
				background: #f5f5f5;
			}
			.container {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
				margin-top: 20px;
			}
			textarea {
				width: 100%;
				height: 500px;
				font-family: 'Courier New', monospace;
				font-size: 12px;
				padding: 10px;
			}
			.controls {
				margin: 20px 0;
			}
			button {
				padding: 10px 15px;
				margin-right: 10px;
				cursor: pointer;
			}
			.file-input {
				margin: 10px 0;
			}
		</style>
	</head>
	<body>
		<h1>Convertidor DOCX a HTML para PDF</h1>

		<div class="controls">
			<input type="file" id="docxFile" accept=".docx" class="file-input" />
			<button id="convertBtn">Convertir DOCX</button>
			<button id="copyBtn">Copiar HTML</button>
		</div>

		<div class="container">
			<div>
				<h3>HTML Generado:</h3>
				<textarea
					id="htmlOutput"
					placeholder="El HTML convertido aparecerá aquí..."></textarea>
			</div>
			<div>
				<h3>Vista Previa:</h3>
				<iframe
					id="preview"
					style="width: 100%; height: 500px; border: 1px solid #ccc; background: white;"
				></iframe>
			</div>
		</div>

		<script>
			// Cargar Mammoth desde CDN
			const script = document.createElement('script');
			script.src =
				'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
			document.head.appendChild(script);

			script.onload = () => {
				const fileInput = document.getElementById('docxFile');
				const convertBtn = document.getElementById('convertBtn');
				const copyBtn = document.getElementById('copyBtn');
				const htmlOutput = document.getElementById('htmlOutput');
				const preview = document.getElementById('preview');

				// Plantilla base para PDF
				const createPDFTemplate = (content, options = {}) => {
					const {
						includeStyles = true,
						pageSize = 'A4',
						margin = '1in',
						header = '',
						footer = '',
					} = options;

					return `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documento PDF</title>
  <style>
    @page { size: A4; margin: 20mm; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#222; line-height:1.5; margin:1rem; }
    table { border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 4px 6px; }
  </style>
</head>
<body>
  <div class="pdf-container">
    ${header ? `<div class="pdf-header">${header}</div>` : ''}
    
    <div class="pdf-content">
      ${content}
    </div>
    
    ${footer ? `<div class="pdf-footer">${footer}</div>` : ''}
  </div>
</body>
</html>`;
				};

				convertBtn.addEventListener('click', async () => {
					const file = fileInput.files[0];

					if (!file) {
						alert('Por favor selecciona un archivo DOCX');
						return;
					}

					try {
						const arrayBuffer = await file.arrayBuffer();
						const result = await mammoth.convertToHtml({ arrayBuffer });

						// Envolver el contenido en la plantilla PDF
						const wrappedHTML = createPDFTemplate(result.value, {
							includeStyles: true,
							pageSize: 'A4',
							margin: '1in',
							header: '<strong>Documento Generado</strong>',
							footer:
								'Página <span class="pageNumber"></span> de <span class="totalPages"></span>',
						});

						htmlOutput.value = wrappedHTML;

						// Actualizar vista previa
						preview.srcdoc = wrappedHTML;

						if (result.messages.length > 0) {
							console.log('Mensajes de conversión:', result.messages);
						}
					} catch (error) {
						console.error('Error convirtiendo el archivo:', error);
						alert(
							'Error al convertir el archivo. Verifica que sea un DOCX válido.',
						);
					}
				});

				copyBtn.addEventListener('click', () => {
					htmlOutput.select();
					document.execCommand('copy');
					alert('HTML copiado al portapapeles');
				});

				// Drag and drop
				document.addEventListener('dragover', (e) => {
					e.preventDefault();
				});

				document.addEventListener('drop', (e) => {
					e.preventDefault();
					const files = e.dataTransfer.files;
					if (files.length > 0 && files[0].name.endsWith('.docx')) {
						fileInput.files = files;
					}
				});
			};
		</script>
	</body>
</html>
