---
import Alerta from '../components/alertageneral.astro'
import LayoutSidebar from '../app/LayoutSidebar.astro';
import LandingReadme from '../modules/LandingReadme-copy.astro';
import { supabase } from '../lib/supabase';

const { cookies, redirect } = Astro;

const accessToken = cookies.get('sb-access-token');
const refreshToken = cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
	return redirect ('/sign-in');
}

const { error } = await supabase.auth.setSession({
	refresh_token: refreshToken.value,
	access_token: accessToken.value,
});

if (error) {
	cookies.delete('sb-access-token', {
		path: '/',
	});
	cookies.delete('sb-refresh-token', {
		path: '/',
	});

	return redirect('/sign-in');
}


---

<LayoutSidebar>
	<Alerta />

	<!-- Script: mostrar/ocultar y limpiar query -->
	<script is:inline>
		(function () {
			const alertBox = document.getElementById('alert-feedback');
			if (!alertBox) return;

			const params = new URLSearchParams(window.location.search);
			const hasMsg = params.has('msg');

			// por si el SSR no lo dejÃ³ visible
			if (hasMsg) {
				alertBox.classList.remove('hidden');
				alertBox.classList.add('flex');

				// autocerrar a los 6s
				const hide = () => {
					alertBox.classList.add('hidden');
					alertBox.classList.remove('flex');
				};
				const timer = setTimeout(hide, 6000);

				// botÃ³n cerrar manual
				const closeBtn = alertBox.querySelector('[data-close]');
				if (closeBtn) {
					closeBtn.addEventListener('click', () => {
						clearTimeout(timer);
						hide();
					});
				}

				// limpiar query de la URL (para que no reaparezca al refrescar)
				params.delete('msg');
				params.delete('status');
				const newUrl = `${location.pathname}${params.toString() ? '?' + params.toString() : ''}${location.hash}`;
				window.history.replaceState({}, '', newUrl);
			} else {
				// asegurar oculto si no hay mensaje
				alertBox.classList.add('hidden');
				alertBox.classList.remove('flex');
			}
		})();
	</script>

	<script is:inline>
		(async function () {
			const alertBox = document.getElementById('alert-feedback');
			if (!alertBox) return;

			const incorpData = localStorage.getItem('incorpData');
			if (!incorpData) {
				return;
			}

			// DefiniciÃ³n de la URL de redirecciÃ³n
			const REDIRECT_URL = '/pages/companias';
			const REDIRECT_DELAY = 3000; // 3 segundos para que el usuario lea el mensaje

			try {
				const data = JSON.parse(incorpData);

				// VALIDACIÃ“N DE NOMBRES DE EMPRESA (Se mantiene igual)
				const nombresEmpresa = [data.nombre_1, data.nombre_2, data.nombre_3];
				const nombresValidos = nombresEmpresa.some(
					(nombre) =>
						nombre !== null && nombre !== undefined && nombre.trim() !== '',
				);

				if (!nombresValidos) {
					window.location.href = '/start/';
					return;
				}

				const formData = new FormData();
				formData.append('tipo_de_empresa', data.tipo_de_empresa);
				formData.append('estado_de_empresa', data.estado_de_empresa);
				formData.append('nombre_1', data.nombre_1 || '');
				formData.append('nombre_2', data.nombre_2 || '');
				formData.append('nombre_3', data.nombre_3 || '');
				formData.append('estado_de', data.estado_de || '');

				const response = await fetch('/api/incorp/save', {
					method: 'POST',
					body: formData,
				});

				if (response.ok) {
					// ----------------------------------------------------
					// ðŸ’¡ BLOQUE DE Ã‰XITO Y REDIRECCIÃ“N
					// ----------------------------------------------------
					localStorage.removeItem('incorpData');

					// 1. Actualizar el mensaje de Ã©xito
					alertBox.querySelector('.ms-3').textContent =
						'âœ… Â¡Ã‰xito! Empresa registrada. Redirigiendo a tus empresas...';

					// 2. Establecer clases para mensaje de Ã©xito (Se mantiene igual)
					alertBox.classList.remove(
						'hidden',
						'text-red-800',
						'border-red-300',
						'bg-red-50',
						'dark:text-red-400',
						'dark:border-red-800',
					);
					alertBox.classList.add(
						'flex',
						'text-green-800',
						'border-green-300',
						'bg-green-50',
						'dark:text-green-400',
						'dark:border-green-800',
					);

					// 3. RedirecciÃ³n automÃ¡tica despuÃ©s del retraso
					setTimeout(() => {
						window.location.href = REDIRECT_URL; // Redirecciona a /pages/companias
					}, REDIRECT_DELAY);

					// NO establecemos el autocierre ni el botÃ³n de cerrar aquÃ­,
					// ya que la pÃ¡gina se va a redirigir en 3 segundos.
				} else {
					// ----------------------------------------------------
					// BLOQUE DE ERROR (Se mantiene igual, solo reestructurado)
					// ----------------------------------------------------
					const errorText = await response.text();
					alertBox.querySelector('.ms-3').textContent =
						`âŒ Error: ${errorText || 'No se pudo registrar la empresa'}`;

					// Remover clases de Ã©xito y aÃ±adir clases de error
					alertBox.classList.remove(
						'hidden',
						'text-green-800',
						'border-green-300',
						'bg-green-50',
						'dark:text-green-400',
						'dark:border-green-800',
					);
					alertBox.classList.add(
						'flex',
						'text-red-800',
						'border-red-300',
						'bg-red-50',
						'dark:text-red-400',
						'dark:border-red-800',
					);

					// LÃ³gica de autocerrar y botÃ³n de cerrar (Solo en caso de error)
					const hide = () => {
						alertBox.classList.add('hidden');
						alertBox.classList.remove('flex');
					};
					const timer = setTimeout(hide, 6000);

					const closeBtn = alertBox.querySelector('[data-close]');
					if (closeBtn) {
						closeBtn.addEventListener('click', () => {
							clearTimeout(timer);
							hide();
						});
					}
				}
			} catch (error) {
				// ----------------------------------------------------
				// BLOQUE CATCH (Manejo de errores de parseo/conexiÃ³n)
				// ----------------------------------------------------
				alertBox.querySelector('.ms-3').textContent =
					`âŒ Error: ${error.message || 'Error de conexiÃ³n'}`;

				// Manejo de clases de error
				alertBox.classList.remove(
					'hidden',
					'text-green-800',
					'border-green-300',
					'bg-green-50',
					'dark:text-green-400',
					'dark:border-green-800',
				);
				alertBox.classList.add(
					'flex',
					'text-red-800',
					'border-red-300',
					'bg-red-50',
					'dark:text-red-400',
					'dark:border-red-800',
				);

				// LÃ³gica de autocerrar y botÃ³n de cerrar
				const hide = () => {
					alertBox.classList.add('hidden');
					alertBox.classList.remove('flex');
				};
				const timer = setTimeout(hide, 6000);

				const closeBtn = alertBox.querySelector('[data-close]');
				if (closeBtn) {
					closeBtn.addEventListener('click', () => {
						clearTimeout(timer);
						hide();
					});
				}
			}
		})();
	</script>
	<LandingReadme />
</LayoutSidebar>
