---
import Alerta from "../components/alertageneral.astro";
import LayoutSidebar from "../app/LayoutSidebar.astro";
import LandingReadme from "../modules/LandingReadme-copy.astro";
import { supabase } from "../lib/supabase";
import { createSupabaseServerClient } from "../lib/supabase-ssr";

// 1) Primero: manejar el ?code=... (usar "/" como callback)
const url = new URL(Astro.request.url);
const code = url.searchParams.get("code");
const statusFromQuery = url.searchParams.get("status");
const msgFromQuery = url.searchParams.get("msg");

if (code) {
  console.log("[index] Detectado code en la URL:", code);

  const supabaseSSR = createSupabaseServerClient({
    headers: Astro.request.headers,
    cookies: Astro.cookies,
  });

  const { data, error } = await supabaseSSR.auth.exchangeCodeForSession(code);

  console.log("[index] Resultado exchangeCodeForSession -> error:", error);
  console.log(
    "[index] Resultado exchangeCodeForSession -> data.session existe?:",
    !!data?.session,
  );

  if (!error && data?.session) {
    const { access_token, refresh_token } = data.session;

    console.log("[index] Seteando cookies sb-access-token / sb-refresh-token...");

    Astro.cookies.set("sb-access-token", access_token, {
      path: "/",
    });

    Astro.cookies.set("sb-refresh-token", refresh_token, {
      path: "/",
    });

    console.log("[index] Cookies seteadas. Redirigiendo SIN code...");

    // Redirigimos limpiando el ?code para no repetir el flujo
    return Astro.redirect(
      "/?status=success&msg=" +
        encodeURIComponent("Sesi√≥n iniciada correctamente con Google."),
    );
  } else {
    console.error("[index] Error al intercambiar code en /:", error);

    return Astro.redirect(
      "/sign-in?status=error&msg=" +
        encodeURIComponent(
          "No se pudo completar el inicio de sesi√≥n con Google. Int√©ntalo nuevamente.",
        ),
    );
  }
}

// 2) Si NO hay ?code=..., ahora s√≠ aplicamos tu guard normal
const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  console.log("[index] No hay cookies de sesi√≥n, redirigiendo a /sign-in");
  return redirect("/sign-in");
}

const { error } = await supabase.auth.setSession({
  refresh_token: refreshToken.value,
  access_token: accessToken.value,
});

if (error) {
  console.error("[index] Error en setSession, limpiando cookies y redirigiendo:", error);

  cookies.delete("sb-access-token", {
    path: "/",
  });
  cookies.delete("sb-refresh-token", {
    path: "/",
  });

  return redirect("/sign-in");
}

// 3) Ya sin code y con sesi√≥n v√°lida, seguimos renderizando el home
const status = statusFromQuery ?? null;
const msg = msgFromQuery ?? null;
---

<LayoutSidebar>
	<Alerta />

	<!-- Script: mostrar/ocultar y limpiar query -->
	<script is:inline>
		(function () {
			const alertBox = document.getElementById('alert-feedback');
			if (!alertBox) return;

			const params = new URLSearchParams(window.location.search);
			const hasMsg = params.has('msg');

			// por si el SSR no lo dej√≥ visible
			if (hasMsg) {
				alertBox.classList.remove('hidden');
				alertBox.classList.add('flex');

				// autocerrar a los 6s
				const hide = () => {
					alertBox.classList.add('hidden');
					alertBox.classList.remove('flex');
				};
				const timer = setTimeout(hide, 6000);

				// bot√≥n cerrar manual
				const closeBtn = alertBox.querySelector('[data-close]');
				if (closeBtn) {
					closeBtn.addEventListener('click', () => {
						clearTimeout(timer);
						hide();
					});
				}

				// limpiar query de la URL (para que no reaparezca al refrescar)
				params.delete('msg');
				params.delete('status');
				const newUrl = `${location.pathname}${params.toString() ? '?' + params.toString() : ''}${location.hash}`;
				window.history.replaceState({}, '', newUrl);
			} else {
				// asegurar oculto si no hay mensaje
				alertBox.classList.add('hidden');
				alertBox.classList.remove('flex');
			}
		})();
	</script>

	<script is:inline>
		(async function () {
			const alertBox = document.getElementById('alert-feedback');
			if (!alertBox) return;

			const incorpData = localStorage.getItem('incorpData');
			if (!incorpData) {
				return;
			}

			// Definici√≥n de la URL de redirecci√≥n
			const REDIRECT_URL = '/pages/companias';
			const REDIRECT_DELAY = 3000; // 3 segundos para que el usuario lea el mensaje

			try {
				const data = JSON.parse(incorpData);

				// VALIDACI√ìN DE NOMBRES DE EMPRESA (Se mantiene igual)
				const nombresEmpresa = [data.nombre_1, data.nombre_2, data.nombre_3];
				const nombresValidos = nombresEmpresa.some(
					(nombre) =>
						nombre !== null && nombre !== undefined && nombre.trim() !== '',
				);

				if (!nombresValidos) {
					window.location.href = '/start/';
					return;
				}

				const formData = new FormData();
				formData.append('tipo_de_empresa', data.tipo_de_empresa);
				formData.append('estado_de_empresa', data.estado_de_empresa);
				formData.append('nombre_1', data.nombre_1 || '');
				formData.append('nombre_2', data.nombre_2 || '');
				formData.append('nombre_3', data.nombre_3 || '');
				formData.append('estado_de', data.estado_de || '');

				const response = await fetch('/api/incorp/save', {
					method: 'POST',
					body: formData,
				});

				if (response.ok) {
					// ----------------------------------------------------
					// üí° BLOQUE DE √âXITO Y REDIRECCI√ìN
					// ----------------------------------------------------
					localStorage.removeItem('incorpData');

					// 1. Actualizar el mensaje de √©xito
					alertBox.querySelector('.ms-3').textContent =
						'‚úÖ ¬°√âxito! Empresa registrada. Redirigiendo a tus empresas...';

					// 2. Establecer clases para mensaje de √©xito (Se mantiene igual)
					alertBox.classList.remove(
						'hidden',
						'text-red-800',
						'border-red-300',
						'bg-red-50',
						'dark:text-red-400',
						'dark:border-red-800',
					);
					alertBox.classList.add(
						'flex',
						'text-green-800',
						'border-green-300',
						'bg-green-50',
						'dark:text-green-400',
						'dark:border-green-800',
					);

					// 3. Redirecci√≥n autom√°tica despu√©s del retraso
					setTimeout(() => {
						window.location.href = REDIRECT_URL; // Redirecciona a /pages/companias
					}, REDIRECT_DELAY);

					// NO establecemos el autocierre ni el bot√≥n de cerrar aqu√≠,
					// ya que la p√°gina se va a redirigir en 3 segundos.
				} else {
					// ----------------------------------------------------
					// BLOQUE DE ERROR (Se mantiene igual, solo reestructurado)
					// ----------------------------------------------------
					const errorText = await response.text();
					alertBox.querySelector('.ms-3').textContent =
						`‚ùå Error: ${errorText || 'No se pudo registrar la empresa'}`;

					// Remover clases de √©xito y a√±adir clases de error
					alertBox.classList.remove(
						'hidden',
						'text-green-800',
						'border-green-300',
						'bg-green-50',
						'dark:text-green-400',
						'dark:border-green-800',
					);
					alertBox.classList.add(
						'flex',
						'text-red-800',
						'border-red-300',
						'bg-red-50',
						'dark:text-red-400',
						'dark:border-red-800',
					);

					// L√≥gica de autocerrar y bot√≥n de cerrar (Solo en caso de error)
					const hide = () => {
						alertBox.classList.add('hidden');
						alertBox.classList.remove('flex');
					};
					const timer = setTimeout(hide, 6000);

					const closeBtn = alertBox.querySelector('[data-close]');
					if (closeBtn) {
						closeBtn.addEventListener('click', () => {
							clearTimeout(timer);
							hide();
						});
					}
				}
			} catch (error) {
				// ----------------------------------------------------
				// BLOQUE CATCH (Manejo de errores de parseo/conexi√≥n)
				// ----------------------------------------------------
				alertBox.querySelector('.ms-3').textContent =
					`‚ùå Error: ${error.message || 'Error de conexi√≥n'}`;

				// Manejo de clases de error
				alertBox.classList.remove(
					'hidden',
					'text-green-800',
					'border-green-300',
					'bg-green-50',
					'dark:text-green-400',
					'dark:border-green-800',
				);
				alertBox.classList.add(
					'flex',
					'text-red-800',
					'border-red-300',
					'bg-red-50',
					'dark:text-red-400',
					'dark:border-red-800',
				);

				// L√≥gica de autocerrar y bot√≥n de cerrar
				const hide = () => {
					alertBox.classList.add('hidden');
					alertBox.classList.remove('flex');
				};
				const timer = setTimeout(hide, 6000);

				const closeBtn = alertBox.querySelector('[data-close]');
				if (closeBtn) {
					closeBtn.addEventListener('click', () => {
						clearTimeout(timer);
						hide();
					});
				}
			}
		})();
	</script>
	<LandingReadme />
</LayoutSidebar>
