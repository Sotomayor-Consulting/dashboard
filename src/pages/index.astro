---
import Alerta from '../components/alertageneral.astro';
import Alertaempresas from '../components/alertaempresas.astro';
import LayoutSidebar from '../app/LayoutSidebar.astro';
import LandingReadme from '../modules/LandingReadme-copy.astro';
import { supabase } from '../lib/supabase';

const { cookies, redirect } = Astro;

const accessToken = cookies.get('sb-access-token');
const refreshToken = cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
	return redirect('/sign-in');
}

const { error } = await supabase.auth.setSession({
	refresh_token: refreshToken.value,
	access_token: accessToken.value,
});

if (error) {
	cookies.delete('sb-access-token', {
		path: '/',
	});
	cookies.delete('sb-refresh-token', {
		path: '/',
	});

	return redirect('/sign-in');
}
---

<LayoutSidebar>
	<Alertaempresas />
	<Alerta />

	<script is:inline>
		(async function () {
			const toast = document.getElementById('toast-feedback');
			const msgWrapper = toast?.querySelector('.ms-3'); // el div
			const msgEl = msgWrapper?.querySelector('span.ms-3'); // el span interno

			const iconWrapper = document.getElementById('toast-icon-wrapper');
			const iconSuccess = document.getElementById('toast-icon-success');
			const iconError = document.getElementById('toast-icon-error');

			// üîî Helper para mostrar el toast
			function showToast(message, options = {}) {
				const {
					isSuccess = false,
					autoClose = true,
					autoCloseMs = 6000,
					redirectTo, // string | undefined
					redirectDelayMs = 3000,
				} = options;

				if (!toast || !msgEl || !iconWrapper || !iconSuccess || !iconError) {
					console.warn('[toast] Elementos del toast no encontrados');
					if (redirectTo) {
						setTimeout(() => {
							window.location.href = redirectTo;
						}, redirectDelayMs);
					}
					return;
				}

				// Texto
				msgEl.textContent = message;

				// Reset de clases base
				toast.classList.remove('hidden');
				toast.classList.add('flex');

				// Colores de texto
				toast.classList.remove(
					'text-green-700',
					'dark:text-green-300',
					'text-red-700',
					'dark:text-red-300',
				);
				toast.classList.add(
					isSuccess ? 'text-green-700' : 'text-red-700',
					isSuccess ? 'dark:text-green-300' : 'dark:text-red-300',
				);

				// Colores del icon wrapper
				iconWrapper.classList.remove(
					'bg-green-100',
					'dark:bg-green-800',
					'bg-red-100',
					'dark:bg-red-800',
				);
				iconWrapper.classList.add(
					isSuccess ? 'bg-green-100' : 'bg-red-100',
					isSuccess ? 'dark:bg-green-800' : 'dark:bg-red-800',
				);

				// Mostrar solo el icono correcto
				iconSuccess.classList.toggle('hidden', !isSuccess);
				iconError.classList.toggle('hidden', isSuccess);

				// Funci√≥n para ocultar
				const hide = () => {
					toast.classList.add('hidden');
					toast.classList.remove('flex');
				};

				let timer;
				if (autoClose && !redirectTo) {
					timer = setTimeout(hide, autoCloseMs);
				}

				// Bot√≥n cerrar (evitar m√∫ltiples listeners duplicados)
				const closeBtn = toast.querySelector(
					'[data-dismiss-target="#toast-feedback"]',
				);
				if (closeBtn) {
					const newCloseBtn = closeBtn.cloneNode(true);
					closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
					newCloseBtn.addEventListener('click', () => {
						if (timer) clearTimeout(timer);
						hide();
					});
				}

				// Redirecci√≥n opcional
				if (redirectTo) {
					setTimeout(() => {
						window.location.href = redirectTo;
					}, redirectDelayMs);
				}
			}

			// ============================
			//   L√ìGICA PRINCIPAL
			// ============================

			const incorpData = localStorage.getItem('incorpData');
			if (!incorpData) return;

			const REDIRECT_URL = '/pages/companias';

			try {
				const data = JSON.parse(incorpData);

				// Validar nombres de empresa
				const nombresEmpresa = [data.nombre_1, data.nombre_2, data.nombre_3];
				const nombresValidos = nombresEmpresa.some(
					(nombre) =>
						nombre !== null &&
						nombre !== undefined &&
						String(nombre).trim() !== '',
				);

				if (!nombresValidos) {
					window.location.href = '/start/';
					return;
				}

				const formData = new FormData();
				formData.append('tipo_de_empresa', data.tipo_de_empresa || '');
				formData.append('estado_de_empresa', data.estado_de_empresa || '');
				formData.append('nombre_1', data.nombre_1 || '');
				formData.append('nombre_2', data.nombre_2 || '');
				formData.append('nombre_3', data.nombre_3 || '');
				formData.append('estado_de', data.estado_de || '');

				const response = await fetch('/api/incorp/save', {
					method: 'POST',
					body: formData,
				});

				if (response.ok) {
					// ‚úÖ √âXITO
					localStorage.removeItem('incorpData');

					showToast(
						'Empresa registrada correctamente. Redirigiendo a tus empresas...',
						{
							isSuccess: true,
							autoClose: false, // no hace falta autocerrar, vamos a redirigir
							redirectTo: REDIRECT_URL,
							redirectDelayMs: 3000,
						},
					);
				} else {
					// ‚ùå ERROR HTTP
					const errorText = await response.text();
					showToast(
						errorText ||
							'No se pudo registrar la empresa. Int√©ntalo nuevamente.',
						{
							isSuccess: false,
							autoClose: true,
							autoCloseMs: 6000,
						},
					);
				}
			} catch (error) {
				console.error('[incorp-save] Error:', error);
				showToast(
					(error && error.message) ||
						'Error de conexi√≥n. Int√©ntalo nuevamente.',
					{
						isSuccess: false,
						autoClose: true,
						autoCloseMs: 6000,
					},
				);
			}
		})();
	</script>

	<LandingReadme />
</LayoutSidebar>
