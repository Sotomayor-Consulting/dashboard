---
import { Image } from 'astro:assets';
import logonotificaciones from '/src/assets/avatarSCI.png';
import NavPagination from '../components/NavPagination.astro'; // si no lo usas, puedes quitarlo
import { supabase } from '../lib/supabase';
import Alerta from '../components/alertageneral.astro';

/* =========================
   4) B칰squeda + paginaci칩n
   ========================= */
const q = (Astro.url.searchParams.get('q') || '').trim();
const page = Math.max(1, Number(Astro.url.searchParams.get('page') || '1'));
const pageSize = 20;
const from = (page - 1) * pageSize;
const to = from + pageSize - 1;

let notificaciones: any[] = [];
let errorMsg = '';
let total = 0;
let totalPages = 1;

let query = supabase
	.from('notifications')
	.select(
		`
    id,
    user_id,
    message,
    is_read,
    leido_en,
    created_at,
    link,
	mensaje_link
  `,
		{ count: 'exact' },
	)
	.order('created_at', { ascending: false });

if (q) {
	const safe = q.replace(/,/g, ''); // .or usa comas para separar condiciones
	query = query.or(
		[
			`id.ilike.%${safe}%`,
			`message.ilike.%${safe}%`,
			`is_read.ilike.%${safe}%`,
			`leido_en.ilike.%${safe}%`,
			`created_at.ilike.%${safe}%`,
			`mensaje_link.ilike.%${safe}%`,
		].join(','),
	);
}

const { data, error, count } = await query.range(from, to);

if (error) {
	errorMsg = error.message;
	console.error('Error leyendo usuarios:', error.message);
} else {
	notificaciones = data ?? [];
	total = count ?? 0;
	totalPages = Math.max(1, Math.ceil(total / pageSize));
}
---

<Alerta />
<div class="flex flex-col">
	<div class="overflow-x-auto">
		<div class="inline-block min-w-full align-middle">
			<div class="overflow-hidden shadow">
				<table
					class="min-w-full divide-y divide-gray-200 table-fixed dark:divide-gray-600"
				>
					<thead class="bg-gray-100 dark:bg-[#374151]">
						<tr>
							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Icono
							</th>
							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Id
							</th>
							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Mensaje
							</th>
							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Link
							</th>

							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Marcado como leido
							</th>
							<th
								scope="col"
								class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400"
							>
								Acciones
							</th>
						</tr>
					</thead>
					<tbody
						class="bg-white divide-y divide-gray-200 dark:bg-[#1d1d1d] dark:divide-gray-700"
					>
						{
							notificaciones.map((user) => (
								<div>
									<tr class="hover:bg-gray-100 dark:hover:bg-neutral-700">
										<td class="w-4 pl-4">
											<Image
												src={logonotificaciones}
												width="44"
												alt="Icono Sotomayor Consulting"
												class="rounded-full"
											/>
										</td>
										<td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-gray-500 overflow-hidden truncate max-w-sm xl:max-w-xs">
											#{user.id}
										</td>
										<td class="max-w-sm p-4  text-base font-normal text-gray-500 truncate xl:max-w-xs dark:text-gray-400">
											{user.message}
										</td>
										<td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
											<a
												href={user.link}
												target="_blank"
												class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-neutral-800 dark:text-white dark:border-gray-600 dark:hover:bg-neutral-700 dark:hover:border-gray-600 dark:focus:ring-gray-700"
											>
												{user.mensaje_link}
											</a>
										</td>

										<td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
											<div class="flex items-center">
												{user.is_read === true ? (
													<div class="h-2.5 w-2.5 rounded-full bg-green-400 mr-2" />
												) : (
													<div class="h-2.5 w-2.5 rounded-full bg-red-500 mr-2" />
												)}
												{user.is_read ? 'Le칤do' : 'No le칤do'}
											</div>
										</td>

										<td class="p-4 space-x-2 whitespace-nowrap">
											<button
												type="button"
												data-modal-target="edit-user-modal"
												data-modal-toggle="edit-user-modal"
												data-edit-user
												data-user-id={user.id}
												data-user-userid={user.user_id}
												data-mensaje={user.message || ''}
												data-isread={user.is_read || ''}
												data-fecha-leido={user.leido_en || ''}
												data-creado={user.created_at || ''}
												data-link={user.link || ''}
												data-mensajelink={user.mensaje_link ?? ''}
												class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-[#8c681d] hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 dark:bg-[#967432] dark:hover:bg-[#8c681d] dark:focus:ring-primary-800"
											>
												<svg
													xmlns="http://www.w3.org/2000/svg"
													class="w-4 h-4 mr-2"
													viewBox="0 0 24 24"
												>
													<path
														fill="currentColor"
														d="M12 9a3 3 0 0 0-3 3a3 3 0 0 0 3 3a3 3 0 0 0 3-3a3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5a5 5 0 0 1 5-5a5 5 0 0 1 5 5a5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"
													/>
												</svg>
												Ver notificaci칩n
											</button>

											<button
												id={`dd-btn-${user.id}`}
												data-dropdown-toggle={`dd-${user.id}`}
												class="inline-flex items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-neutral-700 dark:hover:bg-neutral-700 dark:focus:ring-gray-600"
												type="button"
												aria-haspopup="true"
												aria-expanded="false"
											>
												<svg
													class="w-5 h-5"
													aria-hidden="true"
													xmlns="http://www.w3.org/2000/svg"
													fill="currentColor"
													viewBox="0 0 4 15"
												>
													<path d="M3.5 1.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 6.041a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 5.959a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
												</svg>
											</button>
											<div
												id={`dd-${user.id}`}
												class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-sm w-44 dark:bg-neutral-700 dark:divide-gray-600"
												role="menu"
												aria-labelledby={`dd-btn-${user.id}`}
												data-dropdown-placement="bottom-start"
											>
												<ul
													class="py-2 text-sm text-gray-700 dark:text-gray-200"
													role="none"
												>
													<li>
														{user.is_read === true ? (
															<a
																href="/notificaciones"
																class="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
																role="menuitem"
															>
																Marcar como le칤do
															</a>
														) : (
															<form
																action="/api/update/update-notification"
																method="post"
															>
																<input
																	type="hidden"
																	value="true"
																	name="estado_lectura"
																/>
																<input
																	type="hidden"
																	value={user.id}
																	name="id"
																/>
																<button
																	type="submit"
																	class="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
																	role="menuitem"
																>
																	Marcar como le칤do
																</button>
															</form>
														)}
													</li>
												</ul>
											</div>
										</td>
									</tr>
								</div>
							))
						}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Edit User Modal -->
<div
	class="fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full"
	id="edit-user-modal"
>
	<div class="relative w-full h-full max-w-2xl px-4 md:h-auto">
		<!-- Modal content -->
		<div class="relative bg-white rounded-lg shadow dark:bg-neutral-800">
			<!-- Modal header -->
			<div
				class="flex items-start justify-between p-5 border-b rounded-t dark:border-gray-700"
			>
				<h3 class="text-base leading-relaxed text-gray-500 dark:text-gray-400">
					Notificacion #<span
						class="text-base leading-relaxed text-gray-500 dark:text-gray-400"
						id="display_id"></span>
				</h3>
				<button
					type="button"
					class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-neutral-700 dark:hover:text-white"
					data-modal-toggle="edit-user-modal"
				>
					<svg
						class="w-5 h-5"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
							clip-rule="evenodd"></path></svg
					>
				</button>
			</div>
			<!-- Modal body -->
			<div class="p-4 md:p-5 space-y-4">
				<div class="flex justify-between">
					<p
						class="text-sm leading-relaxed text-gray-500 dark:text-gray-400"
						id="display_leido"
					>
					</p>
					<p
						class="text-sm leading-relaxed text-gray-500 dark:text-gray-400"
						id="display_fecha_creacion"
					>
					</p>
				</div>
				<div>
					<p
						class="text-base leading-relaxed text-gray-500 dark:text-gray-400 mb-3"
					>
						Mensaje:
					</p>
					<p
						class="text-base leading-relaxed text-gray-500 dark:text-gray-300"
						id="display_mensaje"
					>
						No se pudo leer el mensaje de la notificaci칩n.
					</p>
				</div>
				<div class="py-5">
					<a
						href="http://"
						target="_blank"
						rel="noopener noreferrer"
						id="enlace_display_link"
						class="text-white bg-neutral-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-neutral-700 dark:hover:bg-neutral-600 dark:focus:ring-blue-800"
						title="ir"></a>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		// Tipar los botones como HTMLElement (con dataset)
		const btns = document.querySelectorAll<HTMLElement>('[data-edit-user]');

		// Funci칩n auxiliar para setear el texto en cualquier elemento de visualizaci칩n
		function setTextContent(id: string, text: string) {
			const el = document.getElementById(id);
			if (el) {
				el.textContent = text ?? '';
			}
		}

		// Funci칩n auxiliar para establecer atributos (como href, class, src)
		function setAttributeValue(id: string, attribute: string, value: string) {
			const el = document.getElementById(id);
			if (el) {
				el.setAttribute(attribute, value ?? '');
			}
		}

		// Nota: Mantenemos setValue solo si todav칤a lo necesitas para inputs en el modal.
		function setValue(id: string, val: string) {
			const el = document.getElementById(id) as
				| HTMLInputElement
				| HTMLTextAreaElement
				| null;
			if (el) el.value = val ?? '';
		}

		// Funci칩n: Formatea el string ISO de fecha/hora a un formato de fecha corto
		const formatFecha = (fechaStr: string): string => {
			if (!fechaStr) return 'N/A';

			try {
				const dateObj = new Date(fechaStr);
				return dateObj.toLocaleDateString('es-ES', {
					year: 'numeric',
					month: '2-digit',
					day: '2-digit',
				});
			} catch (e) {
				return 'Fecha inv치lida';
			}
		};

		// ----------------------------------------------------------------------

		btns.forEach((btn) => {
			btn.addEventListener('click', () => {
				// Obtenci칩n de DataSets
				const id = btn.dataset.userId ?? '';
				const mensaje = btn.dataset.mensaje ?? '';
				const leido = btn.dataset.isread ?? '';
				const fechalectura = btn.dataset.fechaLeido ?? '';
				const creado = btn.dataset.creado ?? '';
				const link = btn.dataset.link ?? ''; // URL para el href
				const mensajelink = btn.dataset.mensajelink ?? ''; // Texto para el enlace

				// 1. Transformaci칩n del booleano (string)
				const estadoLeidoTexto = leido === 'true' ? 'Le칤do' : 'No le칤do';

				// 2. Formateo de las fechas
				const fechaLeidoFormateada = formatFecha(fechalectura);
				const creadoFormateado = formatFecha(creado);

				// ----------------------------------------------------------------------
				// Asignaci칩n de Link y Texto del Enlace (CLAVE)
				// ----------------------------------------------------------------------
				const enlaceId = 'enlace_display_link'; // ID de tu etiqueta <a>

				// 游꿢 Establece la URL en el atributo href
				setAttributeValue(enlaceId, 'href', link);

				// 游꿢 Establece el texto visible del enlace
				setTextContent(enlaceId, mensajelink);

				// ----------------------------------------------------------------------
				// Asignaci칩n de valores (Display)
				// ----------------------------------------------------------------------

				setTextContent('display_id', id);
				setTextContent('display_mensaje', mensaje);
				setTextContent('display_leido', estadoLeidoTexto);
				setTextContent('display_fecha_lectura', fechaLeidoFormateada);
				setTextContent('display_fecha_creacion', creadoFormateado);

				// Nota: Ya no necesitas estas l칤neas si el enlace tiene su propio ID:
				// setTextContent('display_link', link);
				// setTextContent('display_mensajelink', mensajelink);

				// ... (El resto de tu l칩gica para setValue)
			});
		});
	});
</script>
<!-- A침adir usuario -->
<div
	class="fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full"
	id="add-user-modal"
>
	<div class="relative w-full h-full max-w-2xl px-4 md:h-auto">
		<!-- Modal content -->
		<div class="relative bg-white rounded-lg shadow dark:bg-neutral-800">
			<!-- Modal header -->
			<div
				class="flex items-start justify-between p-5 border-b rounded-t dark:border-gray-700"
			>
				<h3 class="text-xl font-semibold dark:text-white">Invitar usuario</h3>
				<button
					type="button"
					class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-neutral-700 dark:hover:text-white"
					data-modal-toggle="add-user-modal"
				>
					<svg
						class="w-5 h-5"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
							clip-rule="evenodd"></path></svg
					>
				</button>
			</div>
			<!-- Modal body -->
			<form action="/api/update/admin-invite" method="post">
				<div class="p-6 space-y-6">
					<div class="grid gap-6">
						<div class="">
							<label
								for="email"
								class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
								>Correo</label
							>
							<input
								type="email"
								name="correo_create"
								id="email"
								class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-[#1d1d1d] dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
								placeholder="correo@ejemplo.com"
								required
							/>
						</div>
					</div>

					<!-- Modal footer -->
					<div
						class="items-center p-6 border-t border-gray-200 rounded-b dark:border-gray-700"
					>
						<button
							class="text-white bg-[#8c681d] hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-[#967432] dark:hover:bg-[#8c681d] dark:focus:ring-primary-800"
							type="submit">Invitar Usuario</button
						>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- A침adir rol Modal -->
<div
	class="fixed left-0 right-0 z-50 items-center justify-center hidden overflow-x-hidden overflow-y-auto top-4 md:inset-0 h-modal sm:h-full"
	id="rol-modal-admin"
>
	<div class="relative w-full h-full max-w-2xl px-4 md:h-auto">
		<!-- Modal content -->
		<div class="relative bg-white rounded-lg shadow dark:bg-neutral-800">
			<!-- Modal header -->
			<div
				class="flex items-start justify-between p-5 border-b rounded-t dark:border-gray-700"
			>
				<h3 class="text-xl font-semibold dark:text-white">A침adir Rol</h3>
				<button
					type="button"
					class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-neutral-700 dark:hover:text-white"
					data-modal-toggle="rol-modal-admin"
				>
					<svg
						class="w-5 h-5"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
							clip-rule="evenodd"></path></svg
					>
				</button>
			</div>
			<!-- Modal body -->
			<form action="/api/create/admin-new-rol" method="post">
				<div class="p-6 space-y-6">
					<div class="grid gap-6">
						<div class="">
							<label
								for="nombre_rol"
								class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
								>A침ade el nombre del rol</label
							>
							<input
								type="text"
								name="nombre_rol"
								id="rol-create"
								class="shadow-sm bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-[#1d1d1d] dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
								placeholder="admin"
								required
							/>
						</div>
					</div>

					<!-- Modal footer -->
					<div
						class="items-center p-6 border-t border-gray-200 rounded-b dark:border-gray-700"
					>
						<button
							class="text-white bg-[#8c681d] hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-[#967432] dark:hover:bg-[#8c681d] dark:focus:ring-primary-800"
							type="submit">A침adir rol</button
						>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<div
	id="updaterol"
	tabindex="-1"
	aria-hidden="true"
	class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full"
>
	<div class="relative p-4 w-full max-w-2xl h-full md:h-auto">
		<!-- Modal content -->
		<div
			class="relative p-4 bg-white rounded-lg shadow dark:bg-neutral-700 sm:p-5"
		>
			<!-- Modal header -->
			<div
				class="flex justify-between items-center pb-4 mb-4 rounded-t border-b sm:mb-5 dark:border-gray-600"
			>
				<h3 class="text-lg font-semibold text-gray-900 dark:text-white">
					Selecciona el estado del cliente
				</h3>
				<button
					type="button"
					class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"
					data-modal-toggle="updaterol"
				>
					<svg
						aria-hidden="true"
						class="w-5 h-5"
						fill="currentColor"
						viewBox="0 0 20 20"
						xmlns="http://www.w3.org/2000/svg"
						><path
							fill-rule="evenodd"
							d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
							clip-rule="evenodd"></path></svg
					>
					<span class="sr-only">Close modal</span>
				</button>
			</div>
			<!-- Modal body -->
			<form action="/api/update/admin-update" method="post" id="updaterolForm">
				<input type="hidden" name="user_id" id="updaterol_user_id" />
				<div class="p-4 md:p-5 text-center">
					<svg
						class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200"
						aria-hidden="true"
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 20 20"
					>
						<path
							stroke="currentColor"
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path>
					</svg>
					<h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">
						Are you sure you want to delete this product?
					</h3>
					<button
						data-modal-hide="updaterol"
						type="button"
						class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center"
					>
						Yes, I'm sure
					</button>
					<button
						data-modal-hide="updaterol"
						type="button"
						class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700"
						>No, cancel</button
					>
				</div>
			</form>
		</div>
	</div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('updaterolForm');
		const uidInput = document.getElementById('updaterol_user_id');
		const estadoSel = document.getElementById('updaterol_estado');
		const nameSpan = document.getElementById('updaterolUserName');

		// Botones que abren el modal (uno por fila/usuario)
		const btns = document.querySelectorAll('[data-open-estado]');

		btns.forEach((btn) => {
			btn.addEventListener('click', () => {
				const uid = btn.dataset.userId || '';
				const uname = btn.dataset.userName || '';
				const estCur = btn.dataset.userEstado || '';

				// Inyecta user_id y muestra nombre
				uidInput.value = uid;
				nameSpan.textContent = uname ? ` 췅 ${uname}` : '';

				// Preselecciona estado si coincide; si no, deja "(sin cambio)"
				const hasOption = Array.from(estadoSel.options).some(
					(o) => o.value === estCur,
				);
				estadoSel.value = hasOption ? estCur : '';

				// Endpoint + retorno a esta misma p치gina
				const back = location.pathname + location.search;
				form.action = `/api/admin/usuarios/update?back=${encodeURIComponent(back)}`;
			});
		});

		// Anti doble-submit (opcional)
		form?.addEventListener('submit', () => {
			const submitBtn = form?.querySelector('button[type="submit"]');
			if (submitBtn) submitBtn.disabled = true;
		});
	});
</script>

<NavPagination
	page={page}
	total={total}
	pageSize={20}
	searchParams={Astro.url.searchParams}
/>
